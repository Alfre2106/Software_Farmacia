<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sistema de Farmacia - Completo</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #ffffff 0%, #6d6d6d 100%);
        min-height: 100vh;
      }

      /* LOGIN */
      .login-container {
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        padding: 20px;
      }
      .login-box {
        background: white;
        padding: 40px;
        border-radius: 15px;
        box-shadow: 0 15px 50px rgba(0, 0, 0, 0.2);
        width: 100%;
        max-width: 450px;
        animation: slideIn 0.5s ease-out;
      }
      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateY(-30px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .login-header {
        text-align: center;
        margin-bottom: 30px;
      }
      .login-header h1 {
        color: #333;
        font-size: 28px;
        margin-bottom: 10px;
      }
      .login-header p {
        color: #666;
        font-size: 14px;
      }
      .auth-tabs {
        display: flex;
        background: #f8f9fa;
        border-radius: 10px;
        margin-bottom: 25px;
        overflow: hidden;
      }
      .auth-tab {
        flex: 1;
        padding: 15px;
        text-align: center;
        cursor: pointer;
        background: none;
        border: none;
        font-size: 16px;
        font-weight: 600;
        color: #666;
        transition: all 0.3s;
      }
      .auth-tab.active {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
      }
      .auth-tab:not(.active):hover {
        background: #e9ecef;
      }
      .form-view {
        display: none;
      }
      .form-view.active {
        display: block;
        animation: fadeIn 0.3s ease;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .form-group {
        margin-bottom: 20px;
      }
      .form-group label {
        display: block;
        margin-bottom: 8px;
        color: #333;
        font-weight: 600;
        font-size: 14px;
      }
      .form-group input,
      .form-group select,
      .form-group textarea {
        width: 100%;
        padding: 12px;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        font-size: 14px;
        transition: all 0.3s;
      }
      .form-group input:focus,
      .form-group select:focus,
      .form-group textarea:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      }
      .password-hint {
        font-size: 12px;
        color: #666;
        margin-top: 5px;
      }
      .btn {
        width: 100%;
        padding: 12px 24px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
      }
      .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(79, 80, 88, 0.4);
      }
      .alert {
        padding: 12px;
        border-radius: 8px;
        margin-bottom: 20px;
        display: none;
        animation: slideIn 0.3s ease-out;
      }
      .alert-error {
        background: #fee;
        color: #c33;
        border: 1px solid #fcc;
      }
      .alert-success {
        background: #efe;
        color: #3c3;
        border: 1px solid #cfc;
      }

      /* DASHBOARD */
      .dashboard {
        display: none;
        min-height: 100vh;
        background: #f5f7fa;
      }
      .navbar {
        background: white;
        padding: 15px 30px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .navbar-brand {
        font-size: 24px;
        font-weight: bold;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
      }
      .navbar-user {
        display: flex;
        align-items: center;
        gap: 20px;
      }
      .user-info {
        text-align: right;
      }
      .user-name {
        font-weight: 600;
        color: #333;
      }
      .user-role {
        font-size: 12px;
        color: #666;
      }
      .btn-logout {
        padding: 8px 16px;
        background: #dc3545;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 600;
      }
      .btn-logout:hover {
        background: #c82333;
      }
      .container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 30px;
      }
      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }
      .stat-card {
        background: white;
        padding: 25px;
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        transition: all 0.3s;
      }
      .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
      }
      .stat-card h3 {
        color: #666;
        font-size: 13px;
        margin-bottom: 10px;
        text-transform: uppercase;
        font-weight: 600;
      }
      .stat-card .value {
        font-size: 32px;
        font-weight: bold;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
      }
      .menu-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 20px;
      }
      .menu-card {
        background: white;
        padding: 30px;
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        text-align: center;
        cursor: pointer;
        transition: all 0.3s;
      }
      .menu-card:hover {
        transform: translateY(-8px);
        box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
      }
      .menu-card-icon {
        font-size: 48px;
        margin-bottom: 15px;
      }
      .menu-card h3 {
        color: #333;
        margin-bottom: 10px;
        font-size: 18px;
      }
      .menu-card p {
        color: #666;
        font-size: 14px;
      }
      .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
      }
      .page-header h2 {
        color: #333;
        font-size: 28px;
      }
      .btn-primary {
        padding: 10px 20px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
      }
      .btn-secondary {
        padding: 10px 20px;
        background: #6c757d;
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        margin-left: 10px;
        font-weight: 600;
      }
      .search-bar {
        background: white;
        padding: 20px;
        border-radius: 12px;
        margin-bottom: 20px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      }
      .table-container {
        background: white;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      }
      table {
        width: 100%;
        border-collapse: collapse;
      }
      thead {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      }
      th {
        padding: 15px;
        text-align: left;
        color: white;
        font-weight: 600;
        text-transform: uppercase;
        font-size: 12px;
      }
      td {
        padding: 15px;
        border-bottom: 1px solid #e0e0e0;
      }
      tbody tr:hover {
        background: #f8f9fa;
      }
      .badge {
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 600;
        display: inline-block;
      }
      .badge-success {
        background: #d4edda;
        color: #155724;
      }
      .badge-warning {
        background: #fff3cd;
        color: #856404;
      }
      .badge-info {
        background: #d1ecf1;
        color: #0c5460;
      }
      .btn-icon {
        background: none;
        border: none;
        cursor: pointer;
        padding: 5px 10px;
        font-size: 18px;
      }
      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        justify-content: center;
        align-items: center;
        overflow-y: auto;
      }
      .modal-content {
        background: white;
        padding: 30px;
        border-radius: 15px;
        width: 90%;
        max-width: 800px;
        margin: 20px;
      }
      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 2px solid #e0e0e0;
      }
      .modal-header h3 {
        color: #333;
        font-size: 24px;
      }
      .btn-close {
        background: none;
        border: none;
        font-size: 28px;
        cursor: pointer;
        color: #999;
      }
      .form-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 15px;
      }
      .hidden {
        display: none !important;
      }
      .facturacion-grid {
        display: grid;
        grid-template-columns: 1fr 400px;
        gap: 20px;
      }
      .productos-venta,
      .resumen-venta {
        background: white;
        padding: 25px;
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      }
      .item-venta {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 8px;
        margin-bottom: 10px;
      }
      .item-info {
        flex: 1;
      }
      .item-cantidad {
        display: flex;
        align-items: center;
        gap: 10px;
        margin: 0 15px;
      }
      .item-cantidad button {
        width: 30px;
        height: 30px;
        border: none;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 6px;
        cursor: pointer;
      }
      .item-cantidad input {
        width: 60px;
        text-align: center;
        padding: 5px;
        border: 2px solid #e0e0e0;
        border-radius: 6px;
      }
      .total-line {
        display: flex;
        justify-content: space-between;
        padding: 10px 0;
        border-bottom: 1px solid #e0e0e0;
        font-size: 16px;
      }
      .total-final {
        font-size: 28px;
        font-weight: bold;
        color: #28a745;
      }
      .no-data {
        text-align: center;
        padding: 40px;
        color: #999;
      }
      .loading {
        text-align: center;
        padding: 60px;
        color: #666;
      }
      .reporte-card {
        background: white;
        padding: 30px;
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        margin-bottom: 25px;
      }
      .stats-horarios {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 20px;
        margin-top: 20px;
      }
      .stat-horario {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding: 30px;
        border-radius: 15px;
        color: white;
        text-align: center;
      }
      .stat-horario.ma√±ana {
        background: linear-gradient(135deg, #f09819 0%, #edde5d 100%);
      }
      .stat-horario.tarde {
        background: linear-gradient(135deg, #56ccf2 0%, #2f80ed 100%);
      }
      .stat-horario.noche {
        background: linear-gradient(135deg, #2c3e50 0%, #4ca1af 100%);
      }
      .stat-horario-icono {
        font-size: 56px;
        margin-bottom: 15px;
      }
      .stat-horario .valor {
        font-size: 36px;
        font-weight: bold;
        margin-bottom: 12px;
      }
      .bar-chart {
        display: flex;
        align-items: flex-end;
        justify-content: space-around;
        height: 350px;
        padding: 20px;
        gap: 30px;
      }
      .bar-item {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: flex-end;
      }
      .bar {
        width: 100%;
        background: linear-gradient(to top, #667eea 0%, #764ba2 100%);
        border-radius: 10px 10px 0 0;
        position: relative;
        min-height: 30px;
      }
      .bar-value {
        position: absolute;
        top: -35px;
        left: 50%;
        transform: translateX(-50%);
        font-weight: bold;
        color: #333;
      }
      .bar-label {
        margin-top: 15px;
        font-weight: 600;
        color: #333;
        text-align: center;
      }
      .resumen-general {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 20px;
        margin-top: 20px;
      }
      .resumen-item {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 10px;
        border-left: 5px solid #667eea;
      }
      .resumen-item .valor {
        font-size: 26px;
        font-weight: bold;
        color: #333;
      }

    /* Modal de factura m√°s peque√±o */
.modal-factura {
  width: 70%;
  max-width: 600px;
  max-height: 80vh;
  overflow-y: auto;
  animation: fadeIn 0.3s ease;
}

/* Bot√≥n de cierre */
.btn-close {
  background: none;
  border: none;
  font-size: 24px;
  cursor: pointer;
  color: #888;
  transition: color 0.2s;
}
.btn-close:hover {
  color: #333;
}


    </style>
  </head>
  <body>
    <!-- Librer√≠a para generar PDFs -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <!-- LOGIN PAGE -->
    <div id="loginPage" class="login-container">
      <div class="login-box">
        <div class="login-header">
          <h1>FARMASYSTEMüè•</h1>
          <p>Ingrese Sus Credenciales</p>
        </div>
        <div class="auth-tabs">
          <button class="auth-tab active" onclick="showLoginForm()">
            üîì Iniciar Sesi√≥n
          </button>
          <button class="auth-tab" onclick="showRegisterForm()">
            ‚ú® Registrarse
          </button>
        </div>
        <div class="auth-content">
          <div id="loginView" class="form-view active">
            <div id="loginAlert" class="alert"></div>
            <form id="loginForm">
              <div class="form-group">
                <label>üë§ Usuario</label>
                <input
                  type="text"
                  id="loginUsername"
                  required
                  placeholder="Ingrese su usuario"
                />
              </div>
              <div class="form-group">
                <label>üîí Contrase√±a</label>
                <input
                  type="password"
                  id="loginPassword"
                  required
                  placeholder="Ingrese su contrase√±a"
                />
              </div>
              <button type="submit" class="btn">Iniciar Sesi√≥n</button>
            </form>
          </div>
          <div id="registerView" class="form-view">
            <div id="registerAlert" class="alert"></div>
            <form id="registerForm">
              <div class="form-group">
                <label>üë§ Nombre Completo</label>
                <input
                  type="text"
                  id="regNombre"
                  required
                  placeholder="Ej: Juan P√©rez"
                />
              </div>
              <div class="form-group">
                <label>üîë Usuario</label>
                <input
                  type="text"
                  id="regUsername"
                  required
                  placeholder="Nombre de usuario √∫nico"
                  minlength="4"
                />
              </div>
              <div class="form-group">
                <label>üîí Contrase√±a</label>
                <input
                  type="password"
                  id="regPassword"
                  required
                  placeholder="M√≠nimo 6 caracteres"
                  minlength="6"
                />
                <div class="password-hint">‚ö†Ô∏è M√≠nimo 6 caracteres</div>
              </div>
              <div class="form-group">
                <label>üëî Rol en el Sistema</label>
                <select id="regRol" required>
                  <option value="">Seleccione un rol...</option>
                  <option value="administrador">üëë Administrador</option>
                  <option value="vendedor">üíº Vendedor</option>
                  <option value="gerente">üìä Gerente</option>
                </select>
              </div>
              <button type="submit" class="btn">‚ú® Crear Cuenta</button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- DASHBOARD -->
    <div id="dashboardPage" class="dashboard">
      <nav class="navbar">
        <div class="navbar-brand">üè• Sistema de Farmacia</div>
        <div class="navbar-user">
          <div class="user-info">
            <div class="user-name" id="userName"></div>
            <div class="user-role" id="userRole"></div>
          </div>
          <button class="btn-logout" onclick="logout()">Cerrar Sesi√≥n</button>
        </div>
      </nav>
      <div class="container">
        <div id="dashboardView">
          <h2 style="color: #333; margin-bottom: 20px">üìä Panel Principal</h2>
          <div class="stats-grid">
            <div class="stat-card">
              <h3>üì¶ Total Productos</h3>
              <div class="value" id="totalProductos">0</div>
            </div>
            <div class="stat-card">
              <h3>‚ö†Ô∏è Stock Bajo</h3>
              <div class="value" id="productosBajoStock">0</div>
            </div>
            <div class="stat-card">
              <h3>üõí Ventas Hoy</h3>
              <div class="value" id="ventasHoy">0</div>
            </div>
            <div class="stat-card">
              <h3>üí∞ Monto Hoy</h3>
              <div class="value" id="montoVentasHoy">$0</div>
            </div>
          </div>
          <h3 style="color: #333; margin: 30px 0 20px 0">
            üöÄ M√≥dulos del Sistema
          </h3>
          <div class="menu-grid">
            <div class="menu-card" onclick="showProductos()">
              <div class="menu-card-icon">üì¶</div>
              <h3>Productos</h3>
              <p>Inventario</p>
            </div>
            <div class="menu-card" onclick="showFacturacion()">
              <div class="menu-card-icon">üßæ</div>
              <h3>Facturaci√≥n</h3>
              <p>Ventas</p>
            </div>
            <div class="menu-card" onclick="showHistorial()">
              <div class="menu-card-icon">üìã</div>
              <h3>Historial</h3>
              <p>Facturas</p>
            </div>
            <div class="menu-card" onclick="showReportes()">
              <div class="menu-card-icon">üìä</div>
              <h3>Reportes</h3>
              <p>An√°lisis</p>
            </div>
          </div>
        </div>
        <div id="productosView" class="hidden">
          <div class="page-header">
            <h2>üì¶ Productos</h2>
            <div>
              <button class="btn-secondary" onclick="showDashboard()">
                ‚Üê Volver</button
              ><button
                class="btn-primary"
                onclick="showModalProducto()"
                id="btnNuevoProducto"
              >
                + Nuevo
              </button>
            </div>
          </div>
          <div class="search-bar">
            <input
              type="text"
              id="searchProducto"
              placeholder="üîç Buscar..."
              oninput="buscarProductos()"
            />
          </div>
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>C√≥digo</th>
                  <th>Nombre</th>
                  <th>Categor√≠a</th>
                  <th>Precio</th>
                  <th>Stock</th>
                  <th>Estado</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody id="productosTable"></tbody>
            </table>
          </div>
        </div>
        <div id="facturacionView" class="hidden">
          <div class="page-header">
            <h2>üßæ Nueva Venta</h2>
            <button class="btn-secondary" onclick="showDashboard()">
              ‚Üê Volver
            </button>
          </div>
          <div class="facturacion-grid">
            <div>
              <div class="productos-venta" style="margin-bottom: 20px">
                <h3>üë§ Cliente</h3>
                <input
                  type="text"
                  id="searchCliente"
                  placeholder="Buscar..."
                /><button class="btn-primary" onclick="showModalCliente()">
                  + Cliente</button
                ><select
                  id="selectCliente"
                  style="width: 100%; margin-top: 10px"
                >
                  <option value="">General</option>
                </select>
              </div>
              <div class="productos-venta">
                <div
                  style="
                    display: flex;
                    justify-content: space-between;
                    margin-bottom: 15px;
                  "
                >
                  <h3>üõí Productos</h3>
                  <button
                    class="btn-primary"
                    onclick="showModalAgregarProducto()"
                  >
                    + Agregar
                  </button>
                </div>
                <div id="productosVentaList">
                  <p class="no-data">üì¶ Sin productos</p>
                </div>
              </div>
            </div>
            <div class="resumen-venta">
              <h3>üí≥ Resumen</h3>
              <div class="total-line">
                <span>Subtotal:</span><span id="subtotalVenta">$0</span>
              </div>
              <div class="total-line">
                <span>Descuento:</span><span id="descuentoVenta">$0</span>
              </div>
              <div class="total-line" style="border-bottom: 2px solid #667eea">
                <span class="total-final">Total:</span
                ><span class="total-final" id="totalVenta">$0</span>
              </div>
              <div class="form-group">
                <label>M√©todo Pago</label
                ><select id="metodoPago">
                  <option value="efectivo">üíµ Efectivo</option>
                  <option value="tarjeta">üí≥ Tarjeta</option>
                  <option value="transferencia">üè¶ Transferencia</option>
                </select>
              </div>
              <div class="form-group">
                <label>Observaciones</label
                ><textarea id="observaciones" rows="3"></textarea>
              </div>
              <button class="btn" style="width: 100%" onclick="procesarVenta()">
                üí∞ Procesar
              </button>
            </div>
          </div>
        </div>
        <div id="historialView" class="hidden">
          <div class="page-header">
            <h2>üìã Historial</h2>
            <button class="btn-secondary" onclick="showDashboard()">
              ‚Üê Volver
            </button>
          </div>
          <div class="search-bar">
            <div class="form-row">
              <div class="form-group">
                <label>Fecha Inicio</label
                ><input type="date" id="fechaInicio" />
              </div>
              <div class="form-group">
                <label>Fecha Fin</label><input type="date" id="fechaFin" />
              </div>
              <div class="form-group">
                <label>&nbsp;</label
                ><button class="btn-primary" onclick="buscarFacturas()">
                  üîç Buscar
                </button>
              </div>
            </div>
          </div>
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>N√∫mero</th>
                  <th>Fecha</th>
                  <th>Horario</th>
                  <th>Cliente</th>
                  <th>Total</th>
                  <th>Pago</th>
                  <th>Ver</th>
                </tr>
              </thead>
              <tbody id="facturasTable"></tbody>
            </table>
          </div>
        </div>
        <div id="reportesView" class="hidden">
          <div class="page-header">
            <h2>üìä Reportes</h2>
            <button class="btn-secondary" onclick="showDashboard()">
              ‚Üê Volver
            </button>
          </div>
          <div class="search-bar">
            <div class="form-row">
              <div class="form-group">
                <label>Inicio</label
                ><input type="date" id="reporteFechaInicio" />
              </div>
              <div class="form-group">
                <label>Fin</label><input type="date" id="reporteFechaFin" />
              </div>
              <div class="form-group">
                <label>Horario</label
                ><select id="horarioFiltro">
                  <option value="">Todos</option>
                  <option value="ma√±ana">üåÖ Ma√±ana</option>
                  <option value="tarde">‚òÄÔ∏è Tarde</option>
                  <option value="noche">üåô Noche</option>
                </select>
              </div>
              <div class="form-group">
                <label>&nbsp;</label
                ><button class="btn-primary" onclick="cargarReportes()">
                  üîÑ Generar
                </button>
              </div>
            </div>
          </div>
          <div class="reporte-card">
            <h3>üïê Ventas por Horario</h3>
            <div id="loadingHorarios" class="loading">Cargando...</div>
            <div id="ventasHorarios" class="hidden">
              <div class="stats-horarios"></div>
              <div class="bar-chart"></div>
            </div>
            <div id="noDataHorarios" class="no-data hidden">Sin datos</div>
          </div>
          <div class="reporte-card">
            <h3>üìä Resumen</h3>
            <div id="loadingResumen" class="loading">Cargando...</div>
            <div id="resumenGeneral" class="hidden">
              <div class="resumen-general"></div>
            </div>
          </div>
          <div class="reporte-card">
            <h3>üèÜ Productos Vendidos</h3>
            <div id="loadingProductos" class="loading">Cargando...</div>
            <div id="productosVendidos" class="hidden">
              <div class="table-container">
                <table>
                  <thead>
                    <tr>
                      <th>Pos</th>
                      <th>Producto</th>
                      <th>Categor√≠a</th>
                      <th>Cantidad</th>
                      <th>Total</th>
                      <th>Facturas</th>
                    </tr>
                  </thead>
                  <tbody id="productosVendidosTable"></tbody>
                </table>
              </div>
            </div>
            <div id="noDataProductos" class="no-data hidden">Sin datos</div>
          </div>
          <div class="reporte-card">
            <h3>üìÖ Ventas Diarias</h3>
            <div id="loadingDiarias" class="loading">Cargando...</div>
            <div id="ventasDiarias" class="hidden">
              <div class="bar-chart"></div>
            </div>
            <div id="noDataDiarias" class="no-data hidden">Sin datos</div>
          </div>
        </div>
      </div>
    </div>

    <!-- MODALES -->
    <div id="modalProducto" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 id="modalProductoTitle">Producto</h3>
          <button class="btn-close" onclick="closeModalProducto()">√ó</button>
        </div>
        <form id="formProducto">
          <input type="hidden" id="productoId" />
          <div class="form-row">
            <div class="form-group">
              <label>C√≥digo *</label
              ><input type="text" id="productoCodigo" required />
            </div>
            <div class="form-group">
              <label>Nombre *</label
              ><input type="text" id="productoNombre" required />
            </div>
          </div>
          <div class="form-group">
            <label>Descripci√≥n</label
            ><input type="text" id="productoDescripcion" />
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Categor√≠a</label
              ><input type="text" id="productoCategoria" />
            </div>
            <div class="form-group">
              <label>Laboratorio</label
              ><input type="text" id="productoLaboratorio" />
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Precio Compra *</label
              ><input
                type="number"
                id="productoPrecioCompra"
                step="0.01"
                required
              />
            </div>
            <div class="form-group">
              <label>Precio Venta *</label
              ><input
                type="number"
                id="productoPrecioVenta"
                step="0.01"
                required
              />
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Stock *</label
              ><input type="number" id="productoStock" required />
            </div>
            <div class="form-group">
              <label>Stock M√≠nimo *</label
              ><input type="number" id="productoStockMinimo" required />
            </div>
          </div>
          <div class="form-group">
            <label>Vencimiento</label
            ><input type="date" id="productoFechaVencimiento" />
          </div>
          <div style="text-align: right">
            <button
              type="button"
              class="btn-secondary"
              onclick="closeModalProducto()"
            >
              Cancelar</button
            ><button type="submit" class="btn-primary">üíæ Guardar</button>
          </div>
        </form>
      </div>
    </div>
    <div id="modalCliente" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>Cliente</h3>
          <button class="btn-close" onclick="closeModalCliente()">√ó</button>
        </div>
        <form id="formCliente">
          <div class="form-row">
            <div class="form-group">
              <label>Tipo Doc *</label
              ><select id="clienteTipo" required>
                <option value="CC">CC</option>
                <option value="NIT">NIT</option>
              </select>
            </div>
            <div class="form-group">
              <label>N√∫mero *</label
              ><input type="text" id="clienteNumero" required />
            </div>
          </div>
          <div class="form-group">
            <label>Nombre *</label
            ><input type="text" id="clienteNombre" required />
          </div>
          <div class="form-group">
            <label>Tel√©fono</label><input type="text" id="clienteTelefono" />
          </div>
          <div class="form-group">
            <label>Email</label><input type="email" id="clienteEmail" />
          </div>
          <div class="form-group">
            <label>Direcci√≥n</label><input type="text" id="clienteDireccion" />
          </div>
          <div style="text-align: right">
            <button
              type="button"
              class="btn-secondary"
              onclick="closeModalCliente()"
            >
              Cancelar</button
            ><button type="submit" class="btn-primary">üíæ Guardar</button>
          </div>
        </form>
      </div>
    </div>
    <div id="modalAgregarProducto" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>Agregar Producto</h3>
          <button class="btn-close" onclick="closeModalAgregarProducto()">
            √ó
          </button>
        </div>
        <form id="formAgregarProducto">
          <div class="form-group">
            <label>Buscar</label
            ><input
              type="text"
              id="searchProductoVenta"
              placeholder="Nombre o c√≥digo..."
              oninput="buscarProductosVenta()"
            />
          </div>
          <div class="form-group">
            <label>Producto *</label
            ><select
              id="selectProductoVenta"
              required
              onchange="cargarInfoProducto()"
            >
              <option value="">Seleccione...</option>
            </select>
          </div>
          <div id="infoProductoVenta" class="hidden">
            <div class="form-row">
              <div class="form-group">
                <label>Precio</label
                ><input
                  type="number"
                  id="precioUnitario"
                  readonly
                  style="background: #f8f9fa"
                />
              </div>
              <div class="form-group">
                <label>Stock</label
                ><input
                  type="number"
                  id="stockDisponible"
                  readonly
                  style="background: #f8f9fa"
                />
              </div>
            </div>
            <div class="form-group">
              <label>Cantidad *</label
              ><input
                type="number"
                id="cantidadProducto"
                min="1"
                value="1"
                required
              />
            </div>
          </div>
          <div style="text-align: right">
            <button
              type="button"
              class="btn-secondary"
              onclick="closeModalAgregarProducto()"
            >
              Cancelar</button
            ><button type="submit" class="btn-primary">‚ûï Agregar</button>
          </div>
        </form>
      </div>
    </div>
   
    <div id="modalDetalleFactura" class="modal">
  <div class="modal-content modal-factura">
    <div class="modal-header">
      <h3>üßæ Detalle Factura</h3>
      <button class="btn-close" onclick="closeModalDetalle()">√ó</button>
    </div>

    <!-- Contenido din√°mico -->
    <div id="detalleFacturaContent"></div>

    <!-- Botones -->
    <div style="text-align: right; margin-top: 20px;">
      <button class="btn-primary" onclick="imprimirFactura()">üñ®Ô∏è Imprimir</button>
      <button class="btn-secondary" onclick="guardarFacturaPDF()">üíæ Guardar PDF</button>
    </div>
  </div>
</div>
    <script>
      const API_URL = `${window.location.protocol}//${window.location.host}/api`;
      let currentUser = null;
      let productos = [];
      let clientes = [];
      let productosVenta = [];

      function showLoginForm() {
        document.getElementById("loginView").classList.add("active");
        document.getElementById("registerView").classList.remove("active");
        document.querySelectorAll(".auth-tab")[0].classList.add("active");
        document.querySelectorAll(".auth-tab")[1].classList.remove("active");
        document.getElementById("loginAlert").style.display = "none";
        document.getElementById("registerAlert").style.display = "none";
      }

      function showRegisterForm() {
        document.getElementById("registerView").classList.add("active");
        document.getElementById("loginView").classList.remove("active");
        document.querySelectorAll(".auth-tab")[1].classList.add("active");
        document.querySelectorAll(".auth-tab")[0].classList.remove("active");
        document.getElementById("loginAlert").style.display = "none";
        document.getElementById("registerAlert").style.display = "none";
      }

      function showAlert(id, msg, type) {
        const alert = document.getElementById(id);
        alert.textContent = msg;
        alert.className = `alert alert-${type}`;
        alert.style.display = "block";
        setTimeout(() => (alert.style.display = "none"), 5000);
      }

      document
        .getElementById("loginForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const username = document.getElementById("loginUsername").value;
          const password = document.getElementById("loginPassword").value;
          try {
            const response = await fetch(`${API_URL}/login`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              credentials: "include",
              body: JSON.stringify({ username, password }),
            });
            const data = await response.json();
            if (response.ok) {
              currentUser = data.user;
              showAlert(
                "loginAlert",
                `‚úÖ Bienvenido ${data.user.nombre}!`,
                "success"
              );
              setTimeout(() => showDashboard(), 800);
            } else {
              showAlert(
                "loginAlert",
                data.error || "Error al iniciar sesi√≥n",
                "error"
              );
            }
          } catch (error) {
            showAlert("loginAlert", "Error de conexi√≥n", "error");
          }
        });

      document
        .getElementById("registerForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const data = {
            nombre_completo: document.getElementById("regNombre").value,
            username: document.getElementById("regUsername").value,
            password: document.getElementById("regPassword").value,
            rol: document.getElementById("regRol").value,
          };
          if (data.password.length < 6) {
            showAlert(
              "registerAlert",
              "‚ùå Contrase√±a m√≠nimo 6 caracteres",
              "error"
            );
            return;
          }
          if (!data.rol) {
            showAlert("registerAlert", "‚ùå Seleccione un rol", "error");
            return;
          }
          try {
            const response = await fetch(`${API_URL}/register`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(data),
            });
            const result = await response.json();
            if (response.ok) {
              showAlert(
                "registerAlert",
                `‚úÖ ${result.message}! Inicie sesi√≥n`,
                "success"
              );
              document.getElementById("registerForm").reset();
              setTimeout(() => showLoginForm(), 2000);
            } else {
              showAlert("registerAlert", `‚ùå ${result.error}`, "error");
            }
          } catch (error) {
            showAlert("registerAlert", "‚ùå Error de conexi√≥n", "error");
          }
        });

      async function logout() {
        await fetch(`${API_URL}/logout`, {
          method: "POST",
          credentials: "include",
        });
        currentUser = null;
        document.getElementById("loginPage").style.display = "flex";
        document.getElementById("dashboardPage").style.display = "none";
      }

      function showDashboard() {
        document.getElementById("loginPage").style.display = "none";
        document.getElementById("dashboardPage").style.display = "block";
        document.getElementById("dashboardView").classList.remove("hidden");
        document.getElementById("productosView").classList.add("hidden");
        document.getElementById("facturacionView").classList.add("hidden");
        document.getElementById("historialView").classList.add("hidden");
        document.getElementById("reportesView").classList.add("hidden");
        if (currentUser) {
          document.getElementById("userName").textContent = currentUser.nombre;
          document.getElementById(
            "userRole"
          ).textContent = `Rol: ${currentUser.rol}`;
          loadDashboardData();
        }
      }

      function showProductos() {
        hideAllViews();
        document.getElementById("productosView").classList.remove("hidden");
        loadProductos();
        if (currentUser.rol !== "administrador") {
          document.getElementById("btnNuevoProducto").style.display = "none";
        }
      }

      function showFacturacion() {
        hideAllViews();
        document.getElementById("facturacionView").classList.remove("hidden");
        productosVenta = [];
        renderProductosVenta();
        loadClientes();
      }

      function showHistorial() {
        hideAllViews();
        document.getElementById("historialView").classList.remove("hidden");
        loadFacturas();
      }

      function showReportes() {
        hideAllViews();
        document.getElementById("reportesView").classList.remove("hidden");
        const hoy = new Date();
        const hace30dias = new Date();
        hace30dias.setDate(hoy.getDate() - 30);
        document.getElementById("reporteFechaFin").valueAsDate = hoy;
        document.getElementById("reporteFechaInicio").valueAsDate = hace30dias;
        cargarReportes();
      }

      function hideAllViews() {
        document.getElementById("dashboardView").classList.add("hidden");
        document.getElementById("productosView").classList.add("hidden");
        document.getElementById("facturacionView").classList.add("hidden");
        document.getElementById("historialView").classList.add("hidden");
        document.getElementById("reportesView").classList.add("hidden");
      }

      async function loadDashboardData() {
        try {
          const response = await fetch(`${API_URL}/dashboard`, {
            credentials: "include",
          });
          if (response.ok) {
            const data = await response.json();
            document.getElementById("totalProductos").textContent =
              data.total_productos;
            document.getElementById("productosBajoStock").textContent =
              data.productos_bajo_stock;
            document.getElementById("ventasHoy").textContent = data.ventas_hoy;
            document.getElementById(
              "montoVentasHoy"
            ).textContent = `${data.monto_ventas_hoy.toLocaleString("es-CO")}`;
          }
        } catch (error) {
          console.error("Error:", error);
        }
      }

      async function loadProductos(search = "") {
        try {
          const url = search
            ? `${API_URL}/productos?search=${search}`
            : `${API_URL}/productos`;
          const response = await fetch(url, { credentials: "include" });
          if (response.ok) {
            productos = await response.json();
            renderProductos();
          }
        } catch (error) {
          console.error("Error:", error);
        }
      }

      function renderProductos() {
        const tbody = document.getElementById("productosTable");
        if (productos.length === 0) {
          tbody.innerHTML =
            '<tr><td colspan="7" style="text-align: center; padding: 40px;">No hay productos</td></tr>';
          return;
        }
        tbody.innerHTML = productos
          .map((p) => {
            const stockBajo = p.stock_actual <= p.stock_minimo;
            const badge = stockBajo
              ? '<span class="badge badge-warning">‚ö†Ô∏è Stock Bajo</span>'
              : '<span class="badge badge-success">‚úÖ Normal</span>';
            const acciones =
              currentUser.rol === "administrador"
                ? `<button class="btn-icon" onclick="editarProducto(${p.id})">‚úèÔ∏è</button><button class="btn-icon" onclick="eliminarProducto(${p.id})">üóëÔ∏è</button>`
                : "-";
            return `<tr><td><strong>${p.codigo}</strong></td><td>${
              p.nombre
            }</td><td>${p.categoria || "-"}</td><td><strong>${parseFloat(
              p.precio_venta
            ).toLocaleString("es-CO")}</strong></td><td>${
              p.stock_actual
            }</td><td>${badge}</td><td>${acciones}</td></tr>`;
          })
          .join("");
      }

      function buscarProductos() {
        const search = document.getElementById("searchProducto").value;
        loadProductos(search);
      }

      function showModalProducto(producto = null) {
        document.getElementById("modalProducto").style.display = "flex";
        if (producto) {
          document.getElementById("modalProductoTitle").textContent =
            "Editar Producto";
          document.getElementById("productoId").value = producto.id;
          document.getElementById("productoCodigo").value = producto.codigo;
          document.getElementById("productoCodigo").disabled = true;
          document.getElementById("productoNombre").value = producto.nombre;
          document.getElementById("productoDescripcion").value =
            producto.descripcion || "";
          document.getElementById("productoCategoria").value =
            producto.categoria || "";
          document.getElementById("productoLaboratorio").value =
            producto.laboratorio || "";
          document.getElementById("productoPrecioCompra").value =
            producto.precio_compra;
          document.getElementById("productoPrecioVenta").value =
            producto.precio_venta;
          document.getElementById("productoStock").value =
            producto.stock_actual;
          document.getElementById("productoStockMinimo").value =
            producto.stock_minimo;
          document.getElementById("productoFechaVencimiento").value =
            producto.fecha_vencimiento || "";
        } else {
          document.getElementById("modalProductoTitle").textContent =
            "Nuevo Producto";
          document.getElementById("formProducto").reset();
          document.getElementById("productoId").value = "";
          document.getElementById("productoCodigo").disabled = false;
        }
      }

      function closeModalProducto() {
        document.getElementById("modalProducto").style.display = "none";
      }

      document
        .getElementById("formProducto")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const id = document.getElementById("productoId").value;
          const data = {
            codigo: document.getElementById("productoCodigo").value,
            nombre: document.getElementById("productoNombre").value,
            descripcion: document.getElementById("productoDescripcion").value,
            categoria: document.getElementById("productoCategoria").value,
            laboratorio: document.getElementById("productoLaboratorio").value,
            precio_compra: parseFloat(
              document.getElementById("productoPrecioCompra").value
            ),
            precio_venta: parseFloat(
              document.getElementById("productoPrecioVenta").value
            ),
            stock_actual: parseInt(
              document.getElementById("productoStock").value
            ),
            stock_minimo: parseInt(
              document.getElementById("productoStockMinimo").value
            ),
            fecha_vencimiento:
              document.getElementById("productoFechaVencimiento").value || null,
          };
          try {
            const url = id
              ? `${API_URL}/productos/${id}`
              : `${API_URL}/productos`;
            const method = id ? "PUT" : "POST";
            const response = await fetch(url, {
              method,
              headers: { "Content-Type": "application/json" },
              credentials: "include",
              body: JSON.stringify(data),
            });
            if (response.ok) {
              closeModalProducto();
              loadProductos();
              loadDashboardData();
              alert(id ? "‚úÖ Producto actualizado" : "‚úÖ Producto creado");
            } else {
              const error = await response.json();
              alert("‚ùå " + (error.error || "Error"));
            }
          } catch (error) {
            alert("‚ùå Error de conexi√≥n");
          }
        });

      async function editarProducto(id) {
        const producto = productos.find((p) => p.id === id);
        if (producto) showModalProducto(producto);
      }

      async function eliminarProducto(id) {
        if (!confirm("¬øEliminar producto?")) return;
        try {
          const response = await fetch(`${API_URL}/productos/${id}`, {
            method: "DELETE",
            credentials: "include",
          });
          if (response.ok) {
            loadProductos();
            loadDashboardData();
            alert("‚úÖ Producto eliminado");
          }
        } catch (error) {
          alert("‚ùå Error");
        }
      }

      async function loadClientes(search = "") {
        try {
          const url = search
            ? `${API_URL}/clientes?search=${search}`
            : `${API_URL}/clientes`;
          const response = await fetch(url, { credentials: "include" });
          if (response.ok) {
            clientes = await response.json();
            const select = document.getElementById("selectCliente");
            select.innerHTML =
              '<option value="">Cliente General</option>' +
              clientes
                .map(
                  (c) =>
                    `<option value="${c.id}">${c.nombre} - ${c.numero_documento}</option>`
                )
                .join("");
          }
        } catch (error) {
          console.error("Error:", error);
        }
      }

      document
        .getElementById("searchCliente")
        .addEventListener("input", (e) => {
          loadClientes(e.target.value);
        });

      function showModalCliente() {
        document.getElementById("modalCliente").style.display = "flex";
      }

      function closeModalCliente() {
        document.getElementById("modalCliente").style.display = "none";
        document.getElementById("formCliente").reset();
      }

      document
        .getElementById("formCliente")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const data = {
            tipo_documento: document.getElementById("clienteTipo").value,
            numero_documento: document.getElementById("clienteNumero").value,
            nombre: document.getElementById("clienteNombre").value,
            telefono: document.getElementById("clienteTelefono").value,
            email: document.getElementById("clienteEmail").value,
            direccion: document.getElementById("clienteDireccion").value,
          };
          try {
            const response = await fetch(`${API_URL}/clientes`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              credentials: "include",
              body: JSON.stringify(data),
            });
            if (response.ok) {
              closeModalCliente();
              loadClientes();
              alert("‚úÖ Cliente creado");
            } else {
              const error = await response.json();
              alert("‚ùå " + (error.error || "Error"));
            }
          } catch (error) {
            alert("‚ùå Error");
          }
        });

      function showModalAgregarProducto() {
        document.getElementById("modalAgregarProducto").style.display = "flex";
        loadProductos();
        const select = document.getElementById("selectProductoVenta");
        select.innerHTML =
          '<option value="">Seleccione...</option>' +
          productos
            .map(
              (p) =>
                `<option value="${p.id}">${p.nombre} - ${p.precio_venta}</option>`
            )
            .join("");
      }

      function closeModalAgregarProducto() {
        document.getElementById("modalAgregarProducto").style.display = "none";
        document.getElementById("formAgregarProducto").reset();
        document.getElementById("infoProductoVenta").classList.add("hidden");
      }

      function buscarProductosVenta() {
        const search = document
          .getElementById("searchProductoVenta")
          .value.toLowerCase();
        const select = document.getElementById("selectProductoVenta");
        select.innerHTML =
          '<option value="">Seleccione...</option>' +
          productos
            .filter(
              (p) =>
                p.nombre.toLowerCase().includes(search) ||
                p.codigo.toLowerCase().includes(search)
            )
            .map(
              (p) =>
                `<option value="${p.id}">${p.nombre} - ${p.precio_venta}</option>`
            )
            .join("");
      }

      function cargarInfoProducto() {
        const id = parseInt(
          document.getElementById("selectProductoVenta").value
        );
        if (!id) {
          document.getElementById("infoProductoVenta").classList.add("hidden");
          return;
        }
        const producto = productos.find((p) => p.id === id);
        if (producto) {
          document.getElementById("precioUnitario").value =
            producto.precio_venta;
          document.getElementById("stockDisponible").value =
            producto.stock_actual;
          document.getElementById("cantidadProducto").max =
            producto.stock_actual;
          document
            .getElementById("infoProductoVenta")
            .classList.remove("hidden");
        }
      }

      document
        .getElementById("formAgregarProducto")
        .addEventListener("submit", (e) => {
          e.preventDefault();
          const id = parseInt(
            document.getElementById("selectProductoVenta").value
          );
          const cantidad = parseInt(
            document.getElementById("cantidadProducto").value
          );
          const producto = productos.find((p) => p.id === id);
          if (!producto) {
            alert("‚ùå Seleccione producto");
            return;
          }
          if (cantidad > producto.stock_actual) {
            alert(`‚ùå Stock insuficiente: ${producto.stock_actual}`);
            return;
          }
          const existe = productosVenta.find((p) => p.id_producto === id);
          if (existe) {
            existe.cantidad += cantidad;
          } else {
            productosVenta.push({
              id_producto: id,
              nombre: producto.nombre,
              precio_unitario: parseFloat(producto.precio_venta),
              cantidad: cantidad,
              stock_disponible: producto.stock_actual,
            });
          }
          closeModalAgregarProducto();
          renderProductosVenta();
        });

      function renderProductosVenta() {
        const container = document.getElementById("productosVentaList");
        if (productosVenta.length === 0) {
          container.innerHTML = '<p class="no-data">üì¶ Sin productos</p>';
          calcularTotales();
          return;
        }
        container.innerHTML = productosVenta
          .map(
            (item, index) => `
        <div class="item-venta">
            <div class="item-info"><h4>${
              item.nombre
            }</h4><p>${item.precio_unitario.toLocaleString("es-CO")}</p></div>
            <div class="item-cantidad">
                <button type="button" onclick="cambiarCantidad(${index}, -1)">-</button>
                <input type="number" value="${
                  item.cantidad
                }" onchange="actualizarCantidad(${index}, this.value)" min="1" max="${
              item.stock_disponible
            }">
                <button type="button" onclick="cambiarCantidad(${index}, 1)">+</button>
            </div>
            <div><strong>${(
              item.precio_unitario * item.cantidad
            ).toLocaleString("es-CO")}</strong></div>
            <button class="btn-icon" onclick="eliminarProductoVenta(${index})">üóëÔ∏è</button>
        </div>
    `
          )
          .join("");
        calcularTotales();
      }

      function cambiarCantidad(index, delta) {
        const item = productosVenta[index];
        const nuevaCantidad = item.cantidad + delta;
        if (nuevaCantidad < 1 || nuevaCantidad > item.stock_disponible) return;
        item.cantidad = nuevaCantidad;
        renderProductosVenta();
      }

      function actualizarCantidad(index, valor) {
        const cantidad = parseInt(valor);
        const item = productosVenta[index];
        if (cantidad < 1 || cantidad > item.stock_disponible) {
          alert(`‚ùå Cantidad: 1-${item.stock_disponible}`);
          renderProductosVenta();
          return;
        }
        item.cantidad = cantidad;
        renderProductosVenta();
      }

      function eliminarProductoVenta(index) {
        productosVenta.splice(index, 1);
        renderProductosVenta();
      }

      function calcularTotales() {
        const subtotal = productosVenta.reduce(
          (sum, item) => sum + item.precio_unitario * item.cantidad,
          0
        );
        const descuento = 0;
        const total = subtotal - descuento;
        document.getElementById(
          "subtotalVenta"
        ).textContent = `${subtotal.toLocaleString("es-CO")}`;
        document.getElementById(
          "descuentoVenta"
        ).textContent = `${descuento.toLocaleString("es-CO")}`;
        document.getElementById(
          "totalVenta"
        ).textContent = `${total.toLocaleString("es-CO")}`;
      }

      async function procesarVenta() {
        if (productosVenta.length === 0) {
          alert("‚ùå Agregue productos");
          return;
        }
        const data = {
          id_cliente: document.getElementById("selectCliente").value || null,
          productos: productosVenta,
          metodo_pago: document.getElementById("metodoPago").value,
          observaciones: document.getElementById("observaciones").value,
          impuesto: 0,
          descuento: 0,
        };
        try {
          const response = await fetch(`${API_URL}/facturas`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            credentials: "include",
            body: JSON.stringify(data),
          });
          if (response.ok) {
            const result = await response.json();
            alert(
              `‚úÖ Venta exitosa!\nüìã ${
                result.numero_factura
              }\nüí∞ ${result.total.toLocaleString("es-CO")}`
            );
            productosVenta = [];
            renderProductosVenta();
            document.getElementById("selectCliente").value = "";
            document.getElementById("metodoPago").value = "efectivo";
            document.getElementById("observaciones").value = "";
            loadDashboardData();
          } else {
            const error = await response.json();
            alert("‚ùå " + (error.error || "Error"));
          }
        } catch (error) {
          alert("‚ùå Error");
        }
      }

      async function loadFacturas() {
        try {
          const response = await fetch(`${API_URL}/facturas`, {
            credentials: "include",
          });
          if (response.ok) {
            const facturas = await response.json();
            renderFacturas(facturas);
          }
        } catch (error) {
          console.error("Error:", error);
        }
      }

      async function buscarFacturas() {
        const fechaInicio = document.getElementById("fechaInicio").value;
        const fechaFin = document.getElementById("fechaFin").value;
        let url = `${API_URL}/facturas?`;
        if (fechaInicio) url += `fecha_inicio=${fechaInicio}&`;
        if (fechaFin) url += `fecha_fin=${fechaFin}`;
        try {
          const response = await fetch(url, { credentials: "include" });
          if (response.ok) {
            const facturas = await response.json();
            renderFacturas(facturas);
          }
        } catch (error) {
          console.error("Error:", error);
        }
      }

      function renderFacturas(facturas) {
        const tbody = document.getElementById("facturasTable");
        if (facturas.length === 0) {
          tbody.innerHTML =
            '<tr><td colspan="7" style="text-align: center; padding: 40px;">Sin facturas</td></tr>';
          return;
        }
        const horarioBadges = {
          ma√±ana: "badge-warning",
          tarde: "badge-info",
          noche: "badge-info",
        };
        const horarioIconos = { ma√±ana: "üåÖ", tarde: "‚òÄÔ∏è", noche: "üåô" };
        tbody.innerHTML = facturas
          .map(
            (f) => `
        <tr>
            <td><strong>${f.numero_factura}</strong></td>
            <td>${new Date(f.fecha).toLocaleDateString("es-CO", {
              year: "numeric",
              month: "short",
              day: "numeric",
              hour: "2-digit",
              minute: "2-digit",
            })}</td>
            <td><span class="badge ${horarioBadges[f.horario]}">${
              horarioIconos[f.horario]
            } ${
              f.horario.charAt(0).toUpperCase() + f.horario.slice(1)
            }</span></td>
            <td>${f.nombre_cliente || "General"}</td>
            <td><strong>${parseFloat(f.total).toLocaleString(
              "es-CO"
            )}</strong></td>
            <td>${
              f.metodo_pago.charAt(0).toUpperCase() + f.metodo_pago.slice(1)
            }</td>
            <td><button class="btn-icon" onclick="verDetalleFactura(${
              f.id
            })">üëÅÔ∏è</button></td>
        </tr>
    `
          )
          .join("");
      }

      async function verDetalleFactura(id) {
        try {
          const response = await fetch(`${API_URL}/facturas/${id}`, {
            credentials: "include",
          });
          if (response.ok) {
            const factura = await response.json();
            mostrarDetalleFactura(factura);
          }
        } catch (error) {
          console.error("Error:", error);
        }
      }

      function mostrarDetalleFactura(f) {
        const content = `<div style="padding: 20px;"><div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 10px; color: white; margin-bottom: 20px;"><h4>Factura: ${
          f.numero_factura
        }</h4><p>üìÖ ${new Date(f.fecha).toLocaleString(
          "es-CO"
        )}</p><p>‚è∞ ${f.horario.toUpperCase()}</p></div><div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;"><p><strong>üë§ Cliente:</strong> ${
          f.nombre_cliente || "General"
        }</p>${
          f.numero_documento
            ? `<p><strong>üìÑ Doc:</strong> ${f.numero_documento}</p>`
            : ""
        }<p><strong>üí≥ Pago:</strong> ${
          f.metodo_pago
        }</p><p><strong>üë®‚Äçüíº Vendedor:</strong> ${
          f.nombre_usuario
        }</p></div><h4>üõí Productos:</h4><table style="width:100%; margin: 20px 0;"><thead><tr><th>Producto</th><th>Cant.</th><th>Precio</th><th>Subtotal</th></tr></thead><tbody>${f.detalle
          .map(
            (d) =>
              `<tr><td><strong>${d.nombre_producto}</strong><br><small>${
                d.codigo
              }</small></td><td>${d.cantidad}</td><td>${parseFloat(
                d.precio_unitario
              ).toLocaleString("es-CO")}</td><td><strong>${parseFloat(
                d.subtotal
              ).toLocaleString("es-CO")}</strong></td></tr>`
          )
          .join(
            ""
          )}</tbody></table><div style="padding: 20px; background: linear-gradient(135deg, #28a745 0%, #20c997 100%); border-radius: 10px; color: white;"><div style="display: flex; justify-content: space-between; font-size: 24px; font-weight: bold;"><span>TOTAL:</span><span>${parseFloat(
          f.total
        ).toLocaleString("es-CO")}</span></div></div>${
          f.observaciones
            ? `<div style="margin-top: 15px; padding: 15px; background: #fff3cd; border-radius: 8px;"><strong>üìù Obs:</strong> ${f.observaciones}</div>`
            : ""
        }</div>`;
        document.getElementById("detalleFacturaContent").innerHTML = content;
        document.getElementById("modalDetalleFactura").style.display = "flex";
      }

      function closeModalDetalle() {
        document.getElementById("modalDetalleFactura").style.display = "none";
      }

      async function cargarReportes() {
        const fechaInicio = document.getElementById("reporteFechaInicio").value;
        const fechaFin = document.getElementById("reporteFechaFin").value;
        const horario = document.getElementById("horarioFiltro").value;
        if (fechaInicio && fechaFin && fechaInicio > fechaFin) {
          alert("‚ùå Fecha inicio debe ser menor");
          return;
        }
        await Promise.all([
          cargarVentasHorario(fechaInicio, fechaFin),
          cargarResumenGeneral(fechaInicio, fechaFin),
          cargarProductosVendidos(fechaInicio, fechaFin, horario),
          cargarVentasDiarias(fechaInicio, fechaFin),
        ]);
      }

      async function cargarVentasHorario(fechaInicio, fechaFin) {
        const loading = document.getElementById("loadingHorarios");
        const content = document.getElementById("ventasHorarios");
        const noData = document.getElementById("noDataHorarios");
        loading.classList.remove("hidden");
        content.classList.add("hidden");
        noData.classList.add("hidden");
        try {
          let url = `${API_URL}/reportes/ventas-horario?`;
          if (fechaInicio) url += `fecha_inicio=${fechaInicio}&`;
          if (fechaFin) url += `fecha_fin=${fechaFin}`;
          const response = await fetch(url, { credentials: "include" });
          const data = await response.json();
          loading.classList.add("hidden");
          if (data.length === 0) {
            noData.classList.remove("hidden");
            return;
          }
          content.classList.remove("hidden");
          renderVentasHorario(data);
        } catch (error) {
          loading.classList.add("hidden");
          noData.classList.remove("hidden");
          console.error("Error:", error);
        }
      }

      function renderVentasHorario(data) {
        const statsContainer = document.querySelector(
          "#ventasHorarios .stats-horarios"
        );
        const chartContainer = document.querySelector(
          "#ventasHorarios .bar-chart"
        );
        const iconos = { ma√±ana: "üåÖ", tarde: "‚òÄÔ∏è", noche: "üåô" };
        statsContainer.innerHTML = data
          .map(
            (h) =>
              `<div class="stat-horario ${
                h.horario
              }"><div class="stat-horario-icono">${
                iconos[h.horario]
              }</div><h4>${h.horario.toUpperCase()}</h4><div class="valor">${h.monto_total.toLocaleString(
                "es-CO"
              )}</div><div class="detalle">${
                h.cantidad_ventas
              } ventas<br>Prom: ${h.promedio_venta.toLocaleString("es-CO", {
                maximumFractionDigits: 0,
              })}</div></div>`
          )
          .join("");
        const maxMonto = Math.max(...data.map((h) => h.monto_total));
        chartContainer.innerHTML = data
          .map((h) => {
            const altura = (h.monto_total / maxMonto) * 100;
            return `<div class="bar-item"><div class="bar" style="height: ${altura}%;"><div class="bar-value">${(
              h.monto_total / 1000
            ).toFixed(0)}k</div></div><div class="bar-label">${
              iconos[h.horario]
            } ${h.horario.toUpperCase()}<br><small>${
              h.cantidad_ventas
            } ventas</small></div></div>`;
          })
          .join("");
      }

      async function cargarResumenGeneral(fechaInicio, fechaFin) {
        const loading = document.getElementById("loadingResumen");
        const content = document.getElementById("resumenGeneral");
        loading.classList.remove("hidden");
        content.classList.add("hidden");
        try {
          let url = `${API_URL}/reportes/resumen-general?`;
          if (fechaInicio) url += `fecha_inicio=${fechaInicio}&`;
          if (fechaFin) url += `fecha_fin=${fechaFin}`;
          const response = await fetch(url, { credentials: "include" });
          const data = await response.json();
          loading.classList.add("hidden");
          content.classList.remove("hidden");
          renderResumenGeneral(data);
        } catch (error) {
          loading.classList.add("hidden");
          console.error("Error:", error);
        }
      }

      function renderResumenGeneral(data) {
        const container = document.querySelector(
          "#resumenGeneral .resumen-general"
        );
        container.innerHTML = `<div class="resumen-item"><h5>üí∞ Total Ventas</h5><div class="valor">${
          data.monto_total?.toLocaleString("es-CO") || "0"
        }</div></div><div class="resumen-item"><h5>üßæ Facturas</h5><div class="valor">${
          data.total_facturas || 0
        }</div></div><div class="resumen-item"><h5>üìä Promedio</h5><div class="valor">${
          data.promedio_factura?.toLocaleString("es-CO", {
            maximumFractionDigits: 0,
          }) || "0"
        }</div></div><div class="resumen-item"><h5>üíµ Efectivo</h5><div class="valor">${
          data.efectivo?.toLocaleString("es-CO") || "0"
        }</div></div><div class="resumen-item"><h5>üí≥ Tarjeta</h5><div class="valor">${
          data.tarjeta?.toLocaleString("es-CO") || "0"
        }</div></div><div class="resumen-item"><h5>üè¶ Transferencia</h5><div class="valor">${
          data.transferencia?.toLocaleString("es-CO") || "0"
        }</div></div>`;
      }

      async function cargarProductosVendidos(fechaInicio, fechaFin, horario) {
        const loading = document.getElementById("loadingProductos");
        const content = document.getElementById("productosVendidos");
        const noData = document.getElementById("noDataProductos");
        loading.classList.remove("hidden");
        content.classList.add("hidden");
        noData.classList.add("hidden");
        try {
          let url = `${API_URL}/reportes/productos-vendidos?`;
          if (fechaInicio) url += `fecha_inicio=${fechaInicio}&`;
          if (fechaFin) url += `fecha_fin=${fechaFin}&`;
          if (horario) url += `horario=${horario}`;
          const response = await fetch(url, { credentials: "include" });
          const data = await response.json();
          loading.classList.add("hidden");
          if (data.length === 0) {
            noData.classList.remove("hidden");
            return;
          }
          content.classList.remove("hidden");
          renderProductosVendidos(data);
        } catch (error) {
          loading.classList.add("hidden");
          noData.classList.remove("hidden");
          console.error("Error:", error);
        }
      }

      function renderProductosVendidos(data) {
        const tbody = document.getElementById("productosVendidosTable");
        tbody.innerHTML = data
          .map((p, index) => {
            const medalla =
              index === 0
                ? "ü•á"
                : index === 1
                ? "ü•à"
                : index === 2
                ? "ü•â"
                : `${index + 1}¬∞`;
            return `<tr><td style="font-size: 24px; text-align: center;">${medalla}</td><td><strong>${
              p.nombre
            }</strong><br><small style="color: #666;">${
              p.codigo
            }</small></td><td>${p.categoria || "-"}</td><td><strong>${
              p.cantidad_vendida
            }</strong> u</td><td><strong>${p.total_vendido.toLocaleString(
              "es-CO"
            )}</strong></td><td>${p.numero_facturas} facturas</td></tr>`;
          })
          .join("");
      }

      async function cargarVentasDiarias(fechaInicio, fechaFin) {
        const loading = document.getElementById("loadingDiarias");
        const content = document.getElementById("ventasDiarias");
        const noData = document.getElementById("noDataDiarias");
        loading.classList.remove("hidden");
        content.classList.add("hidden");
        noData.classList.add("hidden");
        try {
          let url = `${API_URL}/reportes/ventas-diarias?`;
          if (fechaInicio) url += `fecha_inicio=${fechaInicio}&`;
          if (fechaFin) url += `fecha_fin=${fechaFin}`;
          const response = await fetch(url, { credentials: "include" });
          const data = await response.json();
          loading.classList.add("hidden");
          if (data.length === 0) {
            noData.classList.remove("hidden");
            return;
          }
          content.classList.remove("hidden");
          renderVentasDiarias(data);
        } catch (error) {
          loading.classList.add("hidden");
          noData.classList.remove("hidden");
          console.error("Error:", error);
        }
      }

      function renderVentasDiarias(data) {
        const chartContainer = document.querySelector(
          "#ventasDiarias .bar-chart"
        );
        const dataLimitada = data.slice(-15);
        const maxMonto = Math.max(...dataLimitada.map((d) => d.monto_total));
        chartContainer.innerHTML = dataLimitada
          .map((d) => {
            const altura = (d.monto_total / maxMonto) * 100;
            const fecha = new Date(d.fecha + "T00:00:00");
            const fechaFormato = fecha.toLocaleDateString("es-CO", {
              day: "2-digit",
              month: "short",
            });
            return `<div class="bar-item"><div class="bar" style="height: ${altura}%;"><div class="bar-value">${(
              d.monto_total / 1000
            ).toFixed(
              0
            )}k</div></div><div class="bar-label">${fechaFormato}<br><small>${
              d.cantidad_ventas
            } ventas</small></div></div>`;
          })
          .join("");
      }

      window.addEventListener("load", async () => {
        try {
          const response = await fetch(`${API_URL}/session`, {
            credentials: "include",
          });
          if (response.ok) {
            const data = await response.json();
            if (data.authenticated) {
              currentUser = data.user;
              showDashboard();
            }
          }
        } catch (error) {
          document.getElementById("loginPage").style.display = "flex";
        }
      });

      window.onclick = function (event) {
        if (event.target.classList.contains("modal")) {
          event.target.style.display = "none";
        }
      };


function showModalDetalleFactura(htmlFactura) {
  const modal = document.getElementById("modalDetalleFactura");
  const detalle = document.getElementById("detalleFacturaContent");

  
  detalle.innerHTML = htmlFactura || "";
  modal.style.display = "flex";
}


function closeModalDetalle() {
  const modal = document.getElementById("modalDetalleFactura");
  const detalle = document.getElementById("detalleFacturaContent");
  detalle.innerHTML = ""; 
  modal.style.display = "none";
}

// ‚úÖ Imprimir factura (abre vista limpia sin cerrar modal)
function imprimirFactura() {
  const contenido = document.getElementById('detalleFacturaContent').innerHTML;
  const tituloFactura = (contenido.match(/Factura:\\s*(\\w+)/) || [])[1] || 'Factura';

  const ventana = window.open('', tituloFactura, 'width=900,height=700');
  ventana.document.write(`
    <html>
    <head>
      <title>${tituloFactura}</title>
      <style>
        body { font-family: Arial, sans-serif; padding: 30px; }
        h2, h3 { color: #333; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
        th { background: #f2f2f2; }
        .total { font-weight: bold; font-size: 20px; text-align: right; margin-top: 20px; }
      </style>
    </head>
    <body>
      ${contenido}
    </body>
    </html>
  `);
  ventana.document.close();
  ventana.focus();
  ventana.print();
}


function guardarFacturaPDF() {
  // Verificar que html2pdf est√© disponible
  if (typeof html2pdf === "undefined") {
    alert("‚ö†Ô∏è No se ha cargado la librer√≠a html2pdf.js.");
    return;
  }

  const elemento = document.getElementById('detalleFacturaContent');
  if (!elemento) {
    alert("No se encontr√≥ el contenido de la factura.");
    return;
  }

  const nombreFactura = (elemento.innerHTML.match(/Factura:\\s*(\\w+)/) || [])[1] || 'Factura';

  const opciones = {
    margin: 10,
    filename: `${nombreFactura}.pdf`,
    image: { type: 'jpeg', quality: 0.98 },
    html2canvas: { scale: 2 },
    jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
  };

  html2pdf().set(opciones).from(elemento).save();
}
    </script>
  </body>
</html>

