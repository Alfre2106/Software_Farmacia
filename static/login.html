<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sistema de Farmacia</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #ffffff 0%, #6d6d6d 100%);
        min-height: 100vh;
      }

      /* LOGIN */
      .login-container {
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        padding: 20px;
      }
      .login-box {
        background: white;
        padding: 40px;
        border-radius: 15px;
        box-shadow: 0 15px 50px rgba(0, 0, 0, 0.2);
        width: 100%;
        max-width: 450px;
        animation: slideIn 0.5s ease-out;
      }
      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateY(-30px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .login-header {
        text-align: center;
        margin-bottom: 30px;
      }
      .login-header h1 {
        color: #333;
        font-size: 28px;
        margin-bottom: 10px;
      }
      .login-header p {
        color: #666;
        font-size: 14px;
      }
      .auth-tabs {
        display: flex;
        background: #f8f9fa;
        border-radius: 10px;
        margin-bottom: 25px;
        overflow: hidden;
      }
      .auth-tab {
        flex: 1;
        padding: 15px;
        text-align: center;
        cursor: pointer;
        background: none;
        border: none;
        font-size: 16px;
        font-weight: 600;
        color: #666;
        transition: all 0.3s;
      }
      .auth-tab.active {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
      }
      .auth-tab:not(.active):hover {
        background: #e9ecef;
      }
      .form-view {
        display: none;
      }
      .form-view.active {
        display: block;
        animation: fadeIn 0.3s ease;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .form-group {
        margin-bottom: 20px;
      }
      .form-group label {
        display: block;
        margin-bottom: 8px;
        color: #333;
        font-weight: 600;
        font-size: 14px;
      }
      .form-group input,
      .form-group select,
      .form-group textarea {
        width: 100%;
        padding: 12px;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        font-size: 14px;
        transition: all 0.3s;
      }
      .form-group input:focus,
      .form-group select:focus,
      .form-group textarea:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      }
      .password-hint {
        font-size: 12px;
        color: #666;
        margin-top: 5px;
      }
      .btn {
        width: 100%;
        padding: 12px 24px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
      }
      .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(79, 80, 88, 0.4);
      }
      .alert {
        padding: 12px;
        border-radius: 8px;
        margin-bottom: 20px;
        display: none;
        animation: slideIn 0.3s ease-out;
      }
      .alert-error {
        background: #fee;
        color: #c33;
        border: 1px solid #fcc;
      }
      .alert-success {
        background: #efe;
        color: #3c3;
        border: 1px solid #cfc;
      }

      /* DASHBOARD */
      .dashboard {
        display: none;
        min-height: 100vh;
        background: #f5f7fa;
      }
      .navbar {
        background: white;
        padding: 15px 30px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .navbar-brand {
        font-size: 24px;
        font-weight: bold;
        background: linear-gradient(135deg, #667eea 0%, #2c2433 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
      }
      .navbar-user {
        display: flex;
        align-items: center;
        gap: 20px;
      }
      .user-info {
        text-align: right;
      }
      .user-name {
        font-weight: 600;
        color: #333;
      }
      .user-role {
        font-size: 12px;
        color: #666;
      }
      .btn-logout {
        padding: 8px 16px;
        background: #dc3545;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 600;
      }
      .btn-logout:hover {
        background: #c82333;
      }
      .container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 30px;
      }
      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }
      .stat-card {
        background: white;
        padding: 25px;
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        transition: all 0.3s;
      }
      .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
      }
      .stat-card h3 {
        color: #666;
        font-size: 13px;
        margin-bottom: 10px;
        text-transform: uppercase;
        font-weight: 600;
      }
      .stat-card .value {
        font-size: 32px;
        font-weight: bold;
        background: linear-gradient(135deg, #667eea 0%, #000000 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
      }
      .menu-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 20px;
      }
      .menu-card {
        background: white;
        padding: 30px;
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        text-align: center;
        cursor: pointer;
        transition: all 0.3s;
      }
      .menu-card:hover {
        transform: translateY(-8px);
        box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
      }
      .menu-card-icon {
        font-size: 48px;
        margin-bottom: 15px;
      }
      .menu-card h3 {
        color: #333;
        margin-bottom: 10px;
        font-size: 18px;
      }
      .menu-card p {
        color: #666;
        font-size: 14px;
      }
      .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
      }
      .page-header h2 {
        color: #333;
        font-size: 28px;
      }
      .btn-primary {
        padding: 10px 20px;
        background: linear-gradient(135deg, #667eea 0%, #000000 100%);
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
      }
      .btn-secondary {
        padding: 10px 20px;
        background: #6c757d;
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        margin-left: 10px;
        font-weight: 600;
      }
      .search-bar {
        background: white;
        padding: 20px;
        border-radius: 12px;
        margin-bottom: 20px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      }
      .table-container {
        background: white;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      }
      table {
        width: 100%;
        border-collapse: collapse;
      }
      thead {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      }
      th {
        padding: 15px;
        text-align: left;
        color: white;
        font-weight: 600;
        text-transform: uppercase;
        font-size: 12px;
      }
      td {
        padding: 15px;
        border-bottom: 1px solid #e0e0e0;
      }
      tbody tr:hover {
        background: #f8f9fa;
      }
      .badge {
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 600;
        display: inline-block;
      }
      .badge-success {
        background: #d4edda;
        color: #155724;
      }
      .badge-warning {
        background: #fff3cd;
        color: #856404;
      }
      .badge-info {
        background: #d1ecf1;
        color: #0c5460;
      }
      .btn-icon {
        background: none;
        border: none;
        cursor: pointer;
        padding: 5px 10px;
        font-size: 18px;
      }
      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        justify-content: center;
        align-items: center;
        overflow-y: auto;
      }
      .modal-content {
        background: white;
        padding: 30px;
        border-radius: 15px;
        width: 90%;
        max-width: 800px;
        margin: 20px;
      }
      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 2px solid #e0e0e0;
      }
      .modal-header h3 {
        color: #333;
        font-size: 24px;
      }
      .btn-close {
        background: none;
        border: none;
        font-size: 28px;
        cursor: pointer;
        color: #999;
      }
      .form-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 15px;
      }
      .hidden {
        display: none !important;
      }
      .facturacion-grid {
        display: grid;
        grid-template-columns: 1fr 400px;
        gap: 20px;
      }
      .productos-venta,
      .resumen-venta {
        background: white;
        padding: 25px;
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      }
      .item-venta {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 8px;
        margin-bottom: 10px;
      }
      .item-info {
        flex: 1;
      }
      .item-cantidad {
        display: flex;
        align-items: center;
        gap: 10px;
        margin: 0 15px;
      }
      .item-cantidad button {
        width: 30px;
        height: 30px;
        border: none;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 6px;
        cursor: pointer;
      }
      .item-cantidad input {
        width: 60px;
        text-align: center;
        padding: 5px;
        border: 2px solid #e0e0e0;
        border-radius: 6px;
      }
      .total-line {
        display: flex;
        justify-content: space-between;
        padding: 10px 0;
        border-bottom: 1px solid #e0e0e0;
        font-size: 16px;
      }
      .total-final {
        font-size: 28px;
        font-weight: bold;
        color: #28a745;
      }
      .no-data {
        text-align: center;
        padding: 40px;
        color: #999;
      }
      .loading {
        text-align: center;
        padding: 60px;
        color: #666;
      }
      .reporte-card {
        background: white;
        padding: 30px;
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        margin-bottom: 25px;
      }
      .stats-horarios {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 20px;
        margin-top: 20px;
      }
      .stat-horario {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding: 30px;
        border-radius: 15px;
        color: white;
        text-align: center;
      }
      .stat-horario.ma√±ana {
        background: linear-gradient(135deg, #f09819 0%, #edde5d 100%);
      }
      .stat-horario.tarde {
        background: linear-gradient(135deg, #56ccf2 0%, #2f80ed 100%);
      }
      .stat-horario.noche {
        background: linear-gradient(135deg, #2c3e50 0%, #4ca1af 100%);
      }
      .stat-horario-icono {
        font-size: 56px;
        margin-bottom: 15px;
      }
      .stat-horario .valor {
        font-size: 36px;
        font-weight: bold;
        margin-bottom: 12px;
      }
      .bar-chart {
        display: flex;
        align-items: flex-end;
        justify-content: space-around;
        height: 350px;
        padding: 20px;
        gap: 30px;
      }
      .bar-item {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: flex-end;
      }
      .bar {
        width: 100%;
        background: linear-gradient(to top, #667eea 0%, #764ba2 100%);
        border-radius: 10px 10px 0 0;
        position: relative;
        min-height: 30px;
      }
      .bar-value {
        position: absolute;
        top: -35px;
        left: 50%;
        transform: translateX(-50%);
        font-weight: bold;
        color: #333;
      }
      .bar-label {
        margin-top: 15px;
        font-weight: 600;
        color: #333;
        text-align: center;
      }
      .resumen-general {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 20px;
        margin-top: 20px;
      }
      .resumen-item {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 10px;
        border-left: 5px solid #667eea;
      }
      .resumen-item .valor {
        font-size: 26px;
        font-weight: bold;
        color: #333;
      }

      .modal-factura {
        width: 70%;
        max-width: 600px;
        max-height: 80vh;
        overflow-y: auto;
        animation: fadeIn 0.3s ease;
      }

      .btn-close {
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
        color: #888;
        transition: color 0.2s;
      }
      .btn-close:hover {
        color: #333;
      }

      .toast {
        position: fixed;
        bottom: 25px;
        right: 25px;
        background-color: #1e293b; /* azul oscuro elegante */
        color: #fff;
        padding: 14px 18px;
        border-radius: 10px;
        font-family: "Segoe UI", sans-serif;
        font-size: 14px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        opacity: 0;
        transform: translateY(20px);
        transition: all 0.4s ease;
        z-index: 9999;
      }

      .toast.visible {
        opacity: 1;
        transform: translateY(0);
      }

      .toast.exito {
        background-color: #16a34a; /* verde */
      }

      .toast.error {
        background-color: #dc2626; /* rojo */
      }

      .toast.info {
        background-color: #2563eb; /* azul */
      }
      .stat-card {
        background: white;
        padding: 25px;
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        transition: all 0.3s;
        position: relative;
        overflow: hidden;
      }
      .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
      }
      .stat-card h3 {
        color: #666;
        font-size: 13px;
        margin-bottom: 10px;
        text-transform: uppercase;
        font-weight: 600;
        position: relative;
        z-index: 2;
      }
      .stat-card .value {
        font-size: 32px;
        font-weight: bold;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        position: relative;
        z-index: 2;
      }

      /* Gr√°fico circular de progreso */
      .stat-card::before {
        content: "";
        position: absolute;
        top: -50%;
        right: -50%;
        width: 200%;
        height: 200%;
        background: radial-gradient(
          circle,
          rgba(102, 126, 234, 0.05) 0%,
          transparent 70%
        );
        animation: pulse 3s ease-in-out infinite;
      }

      @keyframes pulse {
        0%,
        100% {
          transform: scale(1);
          opacity: 0.5;
        }
        50% {
          transform: scale(1.1);
          opacity: 0.8;
        }
      }

      /* Mini gr√°fico de barras en el fondo */
      .stat-chart {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        height: 60px;
        display: flex;
        align-items: flex-end;
        gap: 4px;
        padding: 0 15px 10px;
        opacity: 0.15;
      }

      .stat-chart-bar {
        flex: 1;
        background: linear-gradient(to top, #667eea, #764ba2);
        border-radius: 4px 4px 0 0;
        animation: growBar 1.5s ease-out;
        transition: height 0.3s ease;
      }

      @keyframes growBar {
        from {
          height: 0;
        }
      }

      /* C√≠rculo de progreso */
      .progress-ring {
        position: absolute;
        top: 15px;
        right: 15px;
        width: 50px;
        height: 50px;
      }

      .progress-ring-circle {
        transition: stroke-dashoffset 0.5s ease;
        transform: rotate(-90deg);
        transform-origin: 50% 50%;
      }

      /* Indicador de tendencia */
      .trend-indicator {
        position: absolute;
        top: 20px;
        right: 20px;
        font-size: 24px;
        animation: bounce 2s ease-in-out infinite;
      }

      @keyframes bounce {
        0%,
        100% {
          transform: translateY(0);
        }
        50% {
          transform: translateY(-5px);
        }
      }

      /* Ondas animadas */
      .stat-wave {
        position: absolute;
        bottom: 0;
        left: 0;
        width: 100%;
        height: 40px;
        opacity: 0.1;
      }

      .stat-wave path {
        fill: url(#gradient);
        animation: wave 3s ease-in-out infinite;
      }

      @keyframes wave {
        0%,
        100% {
          d: path("M0,20 Q25,10 50,20 T100,20 L100,40 L0,40 Z");
        }
        50% {
          d: path("M0,20 Q25,30 50,20 T100,20 L100,40 L0,40 Z");
        }
      }
      /* ====================================
   NAVBAR CON AVATAR - CSS COMPLETO
   ==================================== */

.navbar {
  background: white;
  padding: 15px 30px;
  box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.navbar-brand {
  font-size: 24px;
  font-weight: bold;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}

.navbar-user {
  display: flex;
  align-items: center;
  gap: 20px;
}

/* ‚ú® CONTENEDOR DEL PERFIL */
.user-profile {
  display: flex;
  align-items: center;
  gap: 15px;
  padding: 8px 16px;
  background: #f8f9fa;
  border-radius: 50px;
  transition: all 0.3s;
}

.user-profile:hover {
  background: #e9ecef;
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
}

/* ‚ú® AVATAR CIRCULAR */
.user-avatar {
  width: 45px;
  height: 45px;
  border-radius: 50%;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-weight: bold;
  font-size: 18px;
  box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
  flex-shrink: 0;
}

/* Si hay imagen dentro del avatar */
.user-avatar img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  border-radius: 50%;
}

/* INFORMACI√ìN DEL USUARIO */
.user-info {
  text-align: right;
}

.user-name {
  font-weight: 600;
  color: #333;
  font-size: 15px;
}

.user-role {
  font-size: 12px;
  color: #666;
  margin-top: 2px;
}

/* BOT√ìN DE CERRAR SESI√ìN */
.btn-logout {
  padding: 10px 20px;
  background: #dc3545;
  color: white;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  font-weight: 600;
  transition: all 0.3s;
}

.btn-logout:hover {
  background: #c82333;
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(220, 53, 69, 0.3);
}

/* ====================================
   RESPONSIVE (M√ìVIL)
   ==================================== */

@media (max-width: 768px) {
  .navbar {
    padding: 12px 15px;
  }
  
  .navbar-brand {
    font-size: 18px;
  }
  
  .user-profile {
    padding: 6px 12px;
    gap: 10px;
  }
  
  .user-avatar {
    width: 38px;
    height: 38px;
    font-size: 16px;
  }
  
  .user-name {
    font-size: 13px;
  }
  
  .user-role {
    font-size: 11px;
  }
  
  .btn-logout {
    padding: 8px 14px;
    font-size: 13px;
  }
}
    </style>
  </head>
  <body>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <!-- LOGIN PAGE -->
    <div id="loginPage" class="login-container">
      <div class="login-box">
        <div class="login-header">
          <h1>FARMASYSTEMüè•</h1>
          <p>Ingrese Sus Credenciales</p>
        </div>
        <div class="auth-tabs">
          <button class="auth-tab active" onclick="showLoginForm()">
            üîì Iniciar Sesi√≥n
          </button>
          <button class="auth-tab" onclick="showRegisterForm()">
            üìù Registrarse
          </button>
        </div>
        <div class="auth-content">
          <div id="loginView" class="form-view active">
            <div id="loginAlert" class="alert"></div>
            <form id="loginForm">
              <div class="form-group">
                <label>üë§ Usuario</label>
                <input
                  type="text"
                  id="loginUsername"
                  required
                  placeholder="Ingrese su usuario"
                />
              </div>
              <div class="form-group">
                <label>üîí Contrase√±a</label>
                <input
                  type="password"
                  id="loginPassword"
                  required
                  placeholder="Ingrese su contrase√±a"
                />
              </div>
              <button type="submit" class="btn">Iniciar Sesi√≥n</button>
            </form>
          </div>
          <div id="registerView" class="form-view">
            <div id="registerAlert" class="alert"></div>
            <form id="registerForm">
              <div class="form-group">
                <label>üë§ Nombre Completo</label>
                <input
                  type="text"
                  id="regNombre"
                  required
                  placeholder="Ej: Juan P√©rez"
                />
              </div>
              <div class="form-group">
                <label>üîë Usuario</label>
                <input
                  type="text"
                  id="regUsername"
                  required
                  placeholder="Nombre de usuario √∫nico"
                  minlength="4"
                />
              </div>
              <div class="form-group">
                <label>üîí Contrase√±a</label>
                <input
                  type="password"
                  id="regPassword"
                  required
                  placeholder="M√≠nimo 6 caracteres"
                  minlength="6"
                />
                <div class="password-hint">‚ö†Ô∏è M√≠nimo 6 caracteres</div>
              </div>
              <div class="form-group">
                <label>üëî Rol en el Sistema</label>
                <select id="regRol" required>
                  <option value="">Seleccione un rol...</option>
                  <option value="administrador">üëë Administrador</option>
                  <option value="vendedor">üíº Vendedor</option>
                  <option value="gerente">üìä Gerente</option>
                </select>
              </div>
              <button type="submit" class="btn">Crear Cuenta</button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- DASHBOARD -->
    <div id="dashboardPage" class="dashboard">
      <nav class="navbar">
        <div class="navbar-brand">üè• FARMA SYSTEM</div>
        <div class="navbar-user">
          <div class="user-profile">
            <div class="user-avatar" id="userAvatar">JC</div>
            <div class="user-info">
              <div class="user-name" id="userName"></div>
              <div class="user-role" id="userRole"></div>
            </div>
          </div>
          <button class="btn-logout" onclick="logout()">Cerrar Sesi√≥n</button>
        </div>
      </nav>
      <div class="container">
        <div id="dashboardView">
          <h2 style="color: #333; margin-bottom: 20px">üìä Panel Principal</h2>
          <div class="stats-grid">
            <!-- Card 1: Total Productos con mini barras -->
            <div class="stat-card">
              <h3>üì¶ Total Productos</h3>
              <div class="value" id="totalProductos">0</div>
              <div class="stat-chart">
                <div class="stat-chart-bar" style="height: 40%"></div>
                <div class="stat-chart-bar" style="height: 65%"></div>
                <div class="stat-chart-bar" style="height: 45%"></div>
                <div class="stat-chart-bar" style="height: 80%"></div>
                <div class="stat-chart-bar" style="height: 70%"></div>
                <div class="stat-chart-bar" style="height: 90%"></div>
                <div class="stat-chart-bar" style="height: 55%"></div>
              </div>
            </div>

            <!-- Card 2: Stock Bajo con c√≠rculo de progreso -->
            <div class="stat-card">
              <h3>‚ö†Ô∏è Stock Bajo</h3>
              <div class="value" id="productosBajoStock">0</div>
              <svg class="progress-ring" viewBox="0 0 50 50">
                <circle
                  cx="25"
                  cy="25"
                  r="20"
                  stroke="#e0e0e0"
                  stroke-width="4"
                  fill="none"
                />
                <circle
                  class="progress-ring-circle"
                  cx="25"
                  cy="25"
                  r="20"
                  stroke="#dc3545"
                  stroke-width="4"
                  fill="none"
                  stroke-dasharray="125.6"
                  stroke-dashoffset="31.4"
                />
              </svg>
            </div>

            <!-- Card 3: Ventas Hoy con tendencia -->
            <div class="stat-card">
              <h3>üõí Ventas Hoy</h3>
              <div class="value" id="ventasHoy">0</div>
              <div class="trend-indicator">üìà</div>
              <div class="stat-chart">
                <div class="stat-chart-bar" style="height: 30%"></div>
                <div class="stat-chart-bar" style="height: 50%"></div>
                <div class="stat-chart-bar" style="height: 60%"></div>
                <div class="stat-chart-bar" style="height: 75%"></div>
                <div class="stat-chart-bar" style="height: 85%"></div>
                <div class="stat-chart-bar" style="height: 95%"></div>
              </div>
            </div>

            <!-- Card 4: Monto Hoy con ondas -->
            <div class="stat-card">
              <h3>üí∞ Monto Hoy</h3>
              <div class="value" id="montoVentasHoy">$0</div>
              <svg
                class="stat-wave"
                viewBox="0 0 100 40"
                preserveAspectRatio="none"
              >
                <defs>
                  <linearGradient
                    id="waveGradient"
                    x1="0%"
                    y1="0%"
                    x2="100%"
                    y2="0%"
                  >
                    <stop offset="0%" style="stop-color: #667eea" />
                    <stop offset="100%" style="stop-color: #764ba2" />
                  </linearGradient>
                </defs>
                <path
                  d="M0,20 Q25,10 50,20 T100,20 L100,40 L0,40 Z"
                  fill="url(#waveGradient)"
                />
              </svg>
            </div>
          </div>
          <h3 style="color: #333; margin: 30px 0 20px 0">
            üöÄ M√≥dulos del Sistema
          </h3>
          <div class="menu-grid">
            <div class="menu-card" onclick="showProductos()">
              <div class="menu-card-icon">üì¶</div>
              <h3>Productos</h3>
              <p>Inventario</p>
            </div>
            <div class="menu-card" onclick="showFacturacion()">
              <div class="menu-card-icon">üßæ</div>
              <h3>Facturaci√≥n</h3>
              <p>Ventas</p>
            </div>
            <div class="menu-card" onclick="showHistorial()">
              <div class="menu-card-icon">üìã</div>
              <h3>Historial</h3>
              <p>Facturas</p>
            </div>
            <div id="btnReportes" class="menu-card" onclick="showReportes()">
              <div class="menu-card-icon">üìä</div>
              <h3>Reportes</h3>
              <p>An√°lisis</p>
            </div>
          </div>
        </div>
        <div id="productosView" class="hidden">
          <div class="page-header">
            <h2>üì¶ Productos</h2>
            <div>
              <button class="btn-secondary" onclick="showDashboard()">
                ‚Üê Volver</button
              ><button
                class="btn-primary"
                onclick="showModalProducto()"
                id="btnNuevoProducto"
              >
                + Nuevo
              </button>
            </div>
          </div>
          <div class="search-bar">
            <input
              type="text"
              id="searchProducto"
              placeholder="üîç Buscar..."
              oninput="buscarProductos()"
            />
          </div>
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>C√≥digo</th>
                  <th>Nombre</th>
                  <th>Categor√≠a</th>
                  <th>Precio</th>
                  <th>Stock</th>
                  <th>Estado</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody id="productosTable"></tbody>
            </table>
          </div>
        </div>
        <div id="facturacionView" class="hidden">
          <div class="page-header">
            <h2>üßæ Nueva Venta</h2>
            <button class="btn-secondary" onclick="showDashboard()">
              ‚Üê Volver
            </button>
          </div>
          <div class="facturacion-grid">
            <div>
              <div class="productos-venta" style="margin-bottom: 20px">
                <h3>üë§ Cliente</h3>
                <input
                  type="text"
                  id="searchCliente"
                  placeholder="Buscar..."
                /><button class="btn-primary" onclick="showModalCliente()">
                  + Cliente</button
                ><select
                  id="selectCliente"
                  style="width: 100%; margin-top: 10px"
                >
                  <option value="">General</option>
                </select>
              </div>
              <div class="productos-venta">
                <div
                  style="
                    display: flex;
                    justify-content: space-between;
                    margin-bottom: 15px;
                  "
                >
                  <h3>üõí Productos</h3>
                  <button
                    class="btn-primary"
                    onclick="showModalAgregarProducto()"
                  >
                    + Agregar
                  </button>
                </div>
                <div id="productosVentaList">
                  <p class="no-data">üì¶ Sin productos</p>
                </div>
              </div>
            </div>
            <div class="resumen-venta">
              <h3>üí≥ Resumen</h3>
              <div class="total-line">
                <span>Subtotal:</span><span id="subtotalVenta">$0</span>
              </div>
              <div class="total-line">
                <span>Descuento:</span><span id="descuentoVenta">$0</span>
              </div>
              <div class="total-line" style="border-bottom: 2px solid #667eea">
                <span class="total-final">Total:</span
                ><span class="total-final" id="totalVenta">$0</span>
              </div>
              <div class="form-group">
                <label>M√©todo Pago</label
                ><select id="metodoPago">
                  <option value="efectivo">üíµ Efectivo</option>
                  <option value="tarjeta">üí≥ Tarjeta</option>
                  <option value="transferencia">üè¶ Transferencia</option>
                </select>
              </div>
              <div class="form-group">
                <label>Observaciones</label
                ><textarea id="observaciones" rows="3"></textarea>
              </div>
              <button class="btn" style="width: 100%" onclick="procesarVenta()">
                üí∞ Procesar
              </button>
            </div>
          </div>
        </div>
        <div id="historialView" class="hidden">
          <div class="page-header">
            <h2>üìã Historial</h2>
            <button class="btn-secondary" onclick="showDashboard()">
              ‚Üê Volver
            </button>
          </div>
          <div class="search-bar">
            <div class="form-row">
              <div class="form-group">
                <label>Fecha Inicio</label
                ><input type="date" id="fechaInicio" />
              </div>
              <div class="form-group">
                <label>Fecha Fin</label><input type="date" id="fechaFin" />
              </div>
              <div class="form-group">
                <label>&nbsp;</label
                ><button class="btn-primary" onclick="buscarFacturas()">
                  üîç Buscar
                </button>
              </div>
            </div>
          </div>
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>N√∫mero</th>
                  <th>Fecha</th>
                  <th>Horario</th>
                  <th>Cliente</th>
                  <th>Total</th>
                  <th>Pago</th>
                  <th>Ver</th>
                </tr>
              </thead>
              <tbody id="facturasTable"></tbody>
            </table>
          </div>
        </div>
        <div id="reportesView" class="hidden">
          <div class="page-header">
            <h2>üìä Reportes</h2>
            <button class="btn-secondary" onclick="showDashboard()">
              ‚Üê Volver
            </button>
          </div>
          <div class="search-bar">
            <div class="form-row">
              <div class="form-group">
                <label>Inicio</label
                ><input type="date" id="reporteFechaInicio" />
              </div>
              <div class="form-group">
                <label>Fin</label><input type="date" id="reporteFechaFin" />
              </div>
              <div class="form-group">
                <label>Horario</label
                ><select id="horarioFiltro">
                  <option value="">Todos</option>
                  <option value="ma√±ana">üåÖ Ma√±ana</option>
                  <option value="tarde">‚òÄÔ∏è Tarde</option>
                  <option value="noche">üåô Noche</option>
                </select>
              </div>
              <div class="form-group">
                <label>&nbsp;</label
                ><button class="btn-primary" onclick="cargarReportes()">
                  üîÑ Generar
                </button>
              </div>
            </div>
          </div>
          <div class="reporte-card">
            <h3>üïê Ventas por Horario</h3>
            <div id="loadingHorarios" class="loading">Cargando...</div>
            <div id="ventasHorarios" class="hidden">
              <div class="stats-horarios"></div>
              <div class="bar-chart"></div>
            </div>
            <div id="noDataHorarios" class="no-data hidden">Sin datos</div>
          </div>
          <div class="reporte-card">
            <h3>üìä Resumen</h3>
            <div id="loadingResumen" class="loading">Cargando...</div>
            <div id="resumenGeneral" class="hidden">
              <div class="resumen-general"></div>
            </div>
          </div>
          <div class="reporte-card">
            <h3>üèÜ Productos Vendidos</h3>
            <div id="loadingProductos" class="loading">Cargando...</div>
            <div id="productosVendidos" class="hidden">
              <div class="table-container">
                <table>
                  <thead>
                    <tr>
                      <th>Pos</th>
                      <th>Producto</th>
                      <th>Categor√≠a</th>
                      <th>Cantidad</th>
                      <th>Total</th>
                      <th>Facturas</th>
                    </tr>
                  </thead>
                  <tbody id="productosVendidosTable"></tbody>
                </table>
              </div>
            </div>
            <div id="noDataProductos" class="no-data hidden">Sin datos</div>
          </div>
          <div class="reporte-card">
            <h3>üìÖ Ventas Diarias</h3>
            <div id="loadingDiarias" class="loading">Cargando...</div>
            <div id="ventasDiarias" class="hidden">
              <div class="bar-chart"></div>
            </div>
            <div id="noDataDiarias" class="no-data hidden">Sin datos</div>
          </div>
        </div>
      </div>
    </div>

    <!-- MODALES -->
    <div id="modalProducto" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 id="modalProductoTitle">Producto</h3>
          <button class="btn-close" onclick="closeModalProducto()">√ó</button>
        </div>
        <form id="formProducto">
          <input type="hidden" id="productoId" />
          <div class="form-row">
            <div class="form-group">
              <label>C√≥digo *</label
              ><input type="text" id="productoCodigo" required />
            </div>
            <div class="form-group">
              <label>Nombre *</label
              ><input type="text" id="productoNombre" required />
            </div>
          </div>
          <div class="form-group">
            <label>Descripci√≥n</label
            ><input type="text" id="productoDescripcion" />
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Categor√≠a</label
              ><input type="text" id="productoCategoria" />
            </div>
            <div class="form-group">
              <label>Laboratorio</label
              ><input type="text" id="productoLaboratorio" />
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Precio Compra *</label
              ><input
                type="number"
                id="productoPrecioCompra"
                step="0.01"
                required
              />
            </div>
            <div class="form-group">
              <label>Precio Venta *</label
              ><input
                type="number"
                id="productoPrecioVenta"
                step="0.01"
                required
              />
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Stock *</label
              ><input type="number" id="productoStock" required />
            </div>
            <div class="form-group">
              <label>Stock M√≠nimo *</label
              ><input type="number" id="productoStockMinimo" required />
            </div>
          </div>
          <div class="form-group">
            <label>Vencimiento</label
            ><input type="date" id="productoFechaVencimiento" />
          </div>
          <div style="text-align: right">
            <button
              type="button"
              class="btn-secondary"
              onclick="closeModalProducto()"
            >
              Cancelar</button
            ><button type="submit" class="btn-primary">üíæ Guardar</button>
          </div>
        </form>
      </div>
    </div>
    <div id="modalCliente" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>Cliente</h3>
          <button class="btn-close" onclick="closeModalCliente()">√ó</button>
        </div>
        <form id="formCliente">
          <div class="form-row">
            <div class="form-group">
              <label>Tipo Doc *</label
              ><select id="clienteTipo" required>
                <option value="CC">CC</option>
                <option value="NIT">NIT</option>
              </select>
            </div>
            <div class="form-group">
              <label>N√∫mero *</label
              ><input type="text" id="clienteNumero" required />
            </div>
          </div>
          <div class="form-group">
            <label>Nombre *</label
            ><input type="text" id="clienteNombre" required />
          </div>
          <div class="form-group">
            <label>Tel√©fono</label><input type="text" id="clienteTelefono" />
          </div>
          <div class="form-group">
            <label>Email</label><input type="email" id="clienteEmail" />
          </div>
          <div class="form-group">
            <label>Direcci√≥n</label><input type="text" id="clienteDireccion" />
          </div>
          <div style="text-align: right">
            <button
              type="button"
              class="btn-secondary"
              onclick="closeModalCliente()"
            >
              Cancelar</button
            ><button type="submit" class="btn-primary">üíæ Guardar</button>
          </div>
        </form>
      </div>
    </div>
    <div id="modalAgregarProducto" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>Agregar Producto</h3>
          <button class="btn-close" onclick="closeModalAgregarProducto()">
            √ó
          </button>
        </div>
        <form id="formAgregarProducto">
          <div class="form-group">
            <label>Buscar</label
            ><input
              type="text"
              id="searchProductoVenta"
              placeholder="Nombre o c√≥digo..."
              oninput="buscarProductosVenta()"
            />
          </div>
          <div class="form-group">
            <label>Producto *</label
            ><select
              id="selectProductoVenta"
              required
              onchange="cargarInfoProducto()"
            >
              <option value="">Seleccione...</option>
            </select>
          </div>
          <div id="infoProductoVenta" class="hidden">
            <div class="form-row">
              <div class="form-group">
                <label>Precio</label
                ><input
                  type="number"
                  id="precioUnitario"
                  readonly
                  style="background: #f8f9fa"
                />
              </div>
              <div class="form-group">
                <label>Stock</label
                ><input
                  type="number"
                  id="stockDisponible"
                  readonly
                  style="background: #f8f9fa"
                />
              </div>
            </div>
            <div class="form-group">
              <label>Cantidad *</label
              ><input
                type="number"
                id="cantidadProducto"
                min="1"
                value="1"
                required
              />
            </div>
          </div>
          <div style="text-align: right">
            <button
              type="button"
              class="btn-secondary"
              onclick="closeModalAgregarProducto()"
            >
              Cancelar</button
            ><button type="submit" class="btn-primary">‚ûï Agregar</button>
          </div>
        </form>
      </div>
    </div>

    <div id="modalDetalleFactura" class="modal">
      <div class="modal-content modal-factura">
        <div class="modal-header">
          <h3>üßæ Detalle Factura</h3>
          <button class="btn-close" onclick="closeModalDetalle()">√ó</button>
        </div>

        <div id="detalleFacturaContent"></div>

        <div style="text-align: right; margin-top: 20px">
          <button class="btn-primary" onclick="imprimirFactura()">
            üñ®Ô∏è Imprimir
          </button>
          <button class="btn-secondary" onclick="guardarFacturaPDF()">
            üíæ Guardar PDF
          </button>
        </div>
      </div>
    </div>
    <div id="toast" class="toast"></div>
    <script>
      const API_URL = `${window.location.protocol}//${window.location.host}/api`;
      let currentUser = null;
      let productos = [];
      let clientes = [];
      let productosVenta = [];

      // ====================================
      // FUNCIONES DE NOTIFICACIONES MODERNAS
      // ====================================

      function showAlert(id, msg, type = "info") {
        const toast = document.getElementById("toast");
        toast.textContent = msg;

        // Remover clases previas
        toast.className = "toast";

        // tipo = "exito", "error" o "info"
        toast.classList.add("visible", type);

        setTimeout(() => {
          toast.classList.remove("visible");
        }, 3000);
      }

      function mostrarConfirmacion(mensaje, callback) {
        const modal = document.createElement("div");
        modal.className = "modal";
        modal.style.display = "flex";
        modal.innerHTML = `
    <div class="modal-content modal-factura" style="max-width: 450px;">
      <div class="modal-header">
        <h3>‚ö†Ô∏è Confirmaci√≥n</h3>
      </div>
      <p style="margin: 25px 0; color: #333; font-size: 16px; line-height: 1.5;">${mensaje}</p>
      <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 25px;">
        <button class="btn-secondary" onclick="this.closest('.modal').remove()">
          ‚ùå Cancelar
        </button>
        <button class="btn-primary" id="btnConfirmarAccion">
          ‚úÖ Confirmar
        </button>
      </div>
    </div>
  `;

        document.body.appendChild(modal);

        document.getElementById("btnConfirmarAccion").onclick = () => {
          modal.remove();
          callback();
        };

        modal.onclick = (e) => {
          if (e.target === modal) modal.remove();
        };
      }

      // ====================================
      // FUNCIONES DE AUTENTICACI√ìN
      // ====================================

      function showLoginForm() {
        document.getElementById("loginView").classList.add("active");
        document.getElementById("registerView").classList.remove("active");
        document.querySelectorAll(".auth-tab")[0].classList.add("active");
        document.querySelectorAll(".auth-tab")[1].classList.remove("active");
        document.getElementById("loginAlert").style.display = "none";
        document.getElementById("registerAlert").style.display = "none";
      }

      function showRegisterForm() {
        document.getElementById("registerView").classList.add("active");
        document.getElementById("loginView").classList.remove("active");
        document.querySelectorAll(".auth-tab")[1].classList.add("active");
        document.querySelectorAll(".auth-tab")[0].classList.remove("active");
        document.getElementById("loginAlert").style.display = "none";
        document.getElementById("registerAlert").style.display = "none";
      }

      document
        .getElementById("loginForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const username = document.getElementById("loginUsername").value;
          const password = document.getElementById("loginPassword").value;
          try {
            const response = await fetch(`${API_URL}/login`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              credentials: "include",
              body: JSON.stringify({ username, password }),
            });
            const data = await response.json();
            if (response.ok) {
              currentUser = data.user;
              showAlert(
                "loginAlert",
                `‚úÖ Bienvenido ${data.user.nombre}!`,
                "exito"
              );
              setTimeout(() => showDashboard(), 800);
            } else {
              showAlert(
                "loginAlert",
                data.error || "Error al iniciar sesi√≥n",
                "error"
              );
            }
          } catch (error) {
            showAlert("loginAlert", "Error de conexi√≥n", "error");
          }
        });

      document
        .getElementById("registerForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const data = {
            nombre_completo: document.getElementById("regNombre").value,
            username: document.getElementById("regUsername").value,
            password: document.getElementById("regPassword").value,
            rol: document.getElementById("regRol").value,
          };
          if (data.password.length < 6) {
            showAlert(
              "registerAlert",
              "‚ùå Contrase√±a m√≠nimo 6 caracteres",
              "error"
            );
            return;
          }
          if (!data.rol) {
            showAlert("registerAlert", "‚ùå Seleccione un rol", "error");
            return;
          }
          try {
            const response = await fetch(`${API_URL}/register`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(data),
            });
            const result = await response.json();
            if (response.ok) {
              showAlert(
                "registerAlert",
                `‚úÖ ${result.message}! Inicie sesi√≥n`,
                "exito"
              );
              document.getElementById("registerForm").reset();
              setTimeout(() => showLoginForm(), 2000);
            } else {
              showAlert("registerAlert", `‚ùå ${result.error}`, "error");
            }
          } catch (error) {
            showAlert("registerAlert", "‚ùå Error de conexi√≥n", "error");
          }
        });

      async function logout() {
        await fetch(`${API_URL}/logout`, {
          method: "POST",
          credentials: "include",
        });
        currentUser = null;

        document.getElementById("loginUsername").value = "";
        document.getElementById("loginPassword").value = "";
        document.getElementById("loginForm").reset();

        document.getElementById("loginAlert").style.display = "none";

        document.getElementById("loginPage").style.display = "flex";
        document.getElementById("dashboardPage").style.display = "none";
      }

      // ====================================
      // NAVEGACI√ìN Y VISTAS
      // ====================================

  function actualizarAvatar(usuario) {
  const avatarContainer = document.getElementById('userAvatar');
  const nombreCompleto = usuario.nombre || 'Usuario';
  
  const iniciales = nombreCompleto
    .split(' ')
    .map(palabra => palabra[0])
    .join('')
    .toUpperCase()
    .substring(0, 2);
  
  avatarContainer.textContent = iniciales;
}

      function showDashboard() {
        document.getElementById("loginPage").style.display = "none";
        document.getElementById("dashboardPage").style.display = "block";
        document.getElementById("dashboardView").classList.remove("hidden");
        document.getElementById("productosView").classList.add("hidden");
        document.getElementById("facturacionView").classList.add("hidden");
        document.getElementById("historialView").classList.add("hidden");
        document.getElementById("reportesView").classList.add("hidden");
        if (currentUser) {
          document.getElementById("userName").textContent = currentUser.nombre;
          document.getElementById(
            "userRole"
          ).textContent = `Rol: ${currentUser.rol}`;

          const btnReportes = document.getElementById("btnReportes");
          if (btnReportes) {
            btnReportes.style.display =
              currentUser.rol === "administrador" ? "block" : "none";
          }

          actualizarAvatar(currentUser);

          loadDashboardData();
        }
      }

      function showProductos() {
        hideAllViews();
        document.getElementById("productosView").classList.remove("hidden");
        loadProductos();
        if (currentUser.rol !== "administrador") {
          document.getElementById("btnNuevoProducto").style.display = "none";
        }
      }

      function showFacturacion() {
        hideAllViews();
        document.getElementById("facturacionView").classList.remove("hidden");
        productosVenta = [];
        renderProductosVenta();
        loadClientes();
      }

      function showHistorial() {
        hideAllViews();
        document.getElementById("historialView").classList.remove("hidden");
        loadFacturas();
      }

      function showReportes() {
        if (currentUser.rol === "administrador") {
          hideAllViews();
          document.getElementById("reportesView").classList.remove("hidden");
          const hoy = new Date();
          const hace30dias = new Date();
          hace30dias.setDate(hoy.getDate() - 30);
          document.getElementById("reporteFechaFin").valueAsDate = hoy;
          document.getElementById("reporteFechaInicio").valueAsDate =
            hace30dias;
          cargarReportes();
        } else {
          showAlert(
            "loginAlert",
            "‚ùå Acceso denegado. Solo administradores pueden ver reportes.",
            "error"
          );
          return;
        }
      }

      function hideAllViews() {
        document.getElementById("dashboardView").classList.add("hidden");
        document.getElementById("productosView").classList.add("hidden");
        document.getElementById("facturacionView").classList.add("hidden");
        document.getElementById("historialView").classList.add("hidden");
        document.getElementById("reportesView").classList.add("hidden");
      }

      // ====================================
      // DASHBOARD
      // ====================================

      async function loadDashboardData() {
        try {
          const response = await fetch(`${API_URL}/dashboard`, {
            credentials: "include",
          });
          if (response.ok) {
            const data = await response.json();
            document.getElementById("totalProductos").textContent =
              data.total_productos;
            document.getElementById("productosBajoStock").textContent =
              data.productos_bajo_stock;
            document.getElementById("ventasHoy").textContent = data.ventas_hoy;
            document.getElementById(
              "montoVentasHoy"
            ).textContent = `${data.monto_ventas_hoy.toLocaleString("es-CO")}`;
          }
        } catch (error) {
          console.error("Error:", error);
        }
      }

      // ====================================
      // PRODUCTOS
      // ====================================

      async function loadProductos(search = "") {
        try {
          const url = search
            ? `${API_URL}/productos?search=${search}`
            : `${API_URL}/productos`;
          const response = await fetch(url, { credentials: "include" });
          if (response.ok) {
            productos = await response.json();
            renderProductos();
          }
        } catch (error) {
          console.error("Error:", error);
        }
      }

      function renderProductos() {
        const tbody = document.getElementById("productosTable");
        if (productos.length === 0) {
          tbody.innerHTML =
            '<tr><td colspan="7" style="text-align: center; padding: 40px;">No hay productos</td></tr>';
          return;
        }
        tbody.innerHTML = productos
          .map((p) => {
            const stockBajo = p.stock_actual <= p.stock_minimo;
            const badge = stockBajo
              ? '<span class="badge badge-warning">‚ö†Ô∏è Stock Bajo</span>'
              : '<span class="badge badge-success">‚úÖ Normal</span>';
            const acciones =
              currentUser.rol === "administrador"
                ? `<button class="btn-icon" onclick="editarProducto(${p.id})">‚úèÔ∏è</button><button class="btn-icon" onclick="eliminarProducto(${p.id})">üóëÔ∏è</button>`
                : "-";
            return `<tr><td><strong>${p.codigo}</strong></td><td>${
              p.nombre
            }</td><td>${p.categoria || "-"}</td><td><strong>${parseFloat(
              p.precio_venta
            ).toLocaleString("es-CO")}</strong></td><td>${
              p.stock_actual
            }</td><td>${badge}</td><td>${acciones}</td></tr>`;
          })
          .join("");
      }

      function buscarProductos() {
        const search = document.getElementById("searchProducto").value;
        loadProductos(search);
      }

      function showModalProducto(producto = null) {
        document.getElementById("modalProducto").style.display = "flex";
        if (producto) {
          document.getElementById("modalProductoTitle").textContent =
            "Editar Producto";
          document.getElementById("productoId").value = producto.id;
          document.getElementById("productoCodigo").value = producto.codigo;
          document.getElementById("productoCodigo").disabled = true;
          document.getElementById("productoNombre").value = producto.nombre;
          document.getElementById("productoDescripcion").value =
            producto.descripcion || "";
          document.getElementById("productoCategoria").value =
            producto.categoria || "";
          document.getElementById("productoLaboratorio").value =
            producto.laboratorio || "";
          document.getElementById("productoPrecioCompra").value =
            producto.precio_compra;
          document.getElementById("productoPrecioVenta").value =
            producto.precio_venta;
          document.getElementById("productoStock").value =
            producto.stock_actual;
          document.getElementById("productoStockMinimo").value =
            producto.stock_minimo;
          document.getElementById("productoFechaVencimiento").value =
            producto.fecha_vencimiento || "";
        } else {
          document.getElementById("modalProductoTitle").textContent =
            "Nuevo Producto";
          document.getElementById("formProducto").reset();
          document.getElementById("productoId").value = "";
          document.getElementById("productoCodigo").disabled = false;
        }
      }

      function closeModalProducto() {
        document.getElementById("modalProducto").style.display = "none";
      }

      document
        .getElementById("formProducto")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const id = document.getElementById("productoId").value;
          const data = {
            codigo: document.getElementById("productoCodigo").value,
            nombre: document.getElementById("productoNombre").value,
            descripcion: document.getElementById("productoDescripcion").value,
            categoria: document.getElementById("productoCategoria").value,
            laboratorio: document.getElementById("productoLaboratorio").value,
            precio_compra: parseFloat(
              document.getElementById("productoPrecioCompra").value
            ),
            precio_venta: parseFloat(
              document.getElementById("productoPrecioVenta").value
            ),
            stock_actual: parseInt(
              document.getElementById("productoStock").value
            ),
            stock_minimo: parseInt(
              document.getElementById("productoStockMinimo").value
            ),
            fecha_vencimiento:
              document.getElementById("productoFechaVencimiento").value || null,
          };
          try {
            const url = id
              ? `${API_URL}/productos/${id}`
              : `${API_URL}/productos`;
            const method = id ? "PUT" : "POST";
            const response = await fetch(url, {
              method,
              headers: { "Content-Type": "application/json" },
              credentials: "include",
              body: JSON.stringify(data),
            });
            if (response.ok) {
              closeModalProducto();
              loadProductos();
              loadDashboardData();
              showAlert(
                "loginAlert",
                id ? "‚úÖ Producto actualizado" : "‚úÖ Producto creado",
                "exito"
              );
            } else {
              const error = await response.json();
              showAlert(
                "loginAlert",
                "‚ùå " + (error.error || "Error"),
                "error"
              );
            }
          } catch (error) {
            showAlert("loginAlert", "‚ùå Error de conexi√≥n", "error");
          }
        });

      async function editarProducto(id) {
        const producto = productos.find((p) => p.id === id);
        if (producto) showModalProducto(producto);
      }

      async function eliminarProducto(id) {
        mostrarConfirmacion(
          "¬øEst√° seguro de eliminar este producto?",
          async () => {
            try {
              const response = await fetch(`${API_URL}/productos/${id}`, {
                method: "DELETE",
                credentials: "include",
              });
              if (response.ok) {
                loadProductos();
                loadDashboardData();
                showAlert("loginAlert", "‚úÖ Producto eliminado", "exito");
              }
            } catch (error) {
              showAlert("loginAlert", "‚ùå Error al eliminar", "error");
            }
          }
        );
      }

      // ====================================
      // CLIENTES
      // ====================================

      async function loadClientes(search = "") {
        try {
          const url = search
            ? `${API_URL}/clientes?search=${search}`
            : `${API_URL}/clientes`;
          const response = await fetch(url, { credentials: "include" });
          if (response.ok) {
            clientes = await response.json();
            const select = document.getElementById("selectCliente");
            select.innerHTML =
              '<option value="">Cliente General</option>' +
              clientes
                .map(
                  (c) =>
                    `<option value="${c.id}">${c.nombre} - ${c.numero_documento}</option>`
                )
                .join("");
          }
        } catch (error) {
          console.error("Error:", error);
        }
      }

      document
        .getElementById("searchCliente")
        .addEventListener("input", (e) => {
          loadClientes(e.target.value);
        });

      function showModalCliente() {
        document.getElementById("modalCliente").style.display = "flex";
      }

      function closeModalCliente() {
        document.getElementById("modalCliente").style.display = "none";
        document.getElementById("formCliente").reset();
      }

      document
        .getElementById("formCliente")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const data = {
            tipo_documento: document.getElementById("clienteTipo").value,
            numero_documento: document.getElementById("clienteNumero").value,
            nombre: document.getElementById("clienteNombre").value,
            telefono: document.getElementById("clienteTelefono").value,
            email: document.getElementById("clienteEmail").value,
            direccion: document.getElementById("clienteDireccion").value,
          };
          try {
            const response = await fetch(`${API_URL}/clientes`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              credentials: "include",
              body: JSON.stringify(data),
            });
            if (response.ok) {
              closeModalCliente();
              loadClientes();
              showAlert("loginAlert", "‚úÖ Cliente creado", "exito");
            } else {
              const error = await response.json();
              showAlert(
                "loginAlert",
                "‚ùå " + (error.error || "Error"),
                "error"
              );
            }
          } catch (error) {
            showAlert("loginAlert", "‚ùå Error de conexi√≥n", "error");
          }
        });

      // ====================================
      // FACTURACI√ìN
      // ====================================

      function showModalAgregarProducto() {
        document.getElementById("modalAgregarProducto").style.display = "flex";
        loadProductos();
        const select = document.getElementById("selectProductoVenta");
        select.innerHTML =
          '<option value="">Seleccione...</option>' +
          productos
            .map(
              (p) =>
                `<option value="${p.id}">${p.nombre} - ${p.precio_venta}</option>`
            )
            .join("");
      }

      function closeModalAgregarProducto() {
        document.getElementById("modalAgregarProducto").style.display = "none";
        document.getElementById("formAgregarProducto").reset();
        document.getElementById("infoProductoVenta").classList.add("hidden");
      }

      function buscarProductosVenta() {
        const search = document
          .getElementById("searchProductoVenta")
          .value.toLowerCase();
        const select = document.getElementById("selectProductoVenta");
        select.innerHTML =
          '<option value="">Seleccione...</option>' +
          productos
            .filter(
              (p) =>
                p.nombre.toLowerCase().includes(search) ||
                p.codigo.toLowerCase().includes(search)
            )
            .map(
              (p) =>
                `<option value="${p.id}">${p.nombre} - ${p.precio_venta}</option>`
            )
            .join("");
      }

      function cargarInfoProducto() {
        const id = parseInt(
          document.getElementById("selectProductoVenta").value
        );
        if (!id) {
          document.getElementById("infoProductoVenta").classList.add("hidden");
          return;
        }
        const producto = productos.find((p) => p.id === id);
        if (producto) {
          document.getElementById("precioUnitario").value =
            producto.precio_venta;
          document.getElementById("stockDisponible").value =
            producto.stock_actual;
          document.getElementById("cantidadProducto").max =
            producto.stock_actual;
          document
            .getElementById("infoProductoVenta")
            .classList.remove("hidden");
        }
      }

      document
        .getElementById("formAgregarProducto")
        .addEventListener("submit", (e) => {
          e.preventDefault();
          const id = parseInt(
            document.getElementById("selectProductoVenta").value
          );
          const cantidad = parseInt(
            document.getElementById("cantidadProducto").value
          );
          const producto = productos.find((p) => p.id === id);
          if (!producto) {
            showAlert("loginAlert", "‚ùå Seleccione un producto", "error");
            return;
          }
          if (cantidad > producto.stock_actual) {
            showAlert(
              "loginAlert",
              `‚ùå Stock insuficiente. Disponible: ${producto.stock_actual}`,
              "error"
            );
            return;
          }
          const existe = productosVenta.find((p) => p.id_producto === id);
          if (existe) {
            existe.cantidad += cantidad;
          } else {
            productosVenta.push({
              id_producto: id,
              nombre: producto.nombre,
              precio_unitario: parseFloat(producto.precio_venta),
              cantidad: cantidad,
              stock_disponible: producto.stock_actual,
            });
          }
          closeModalAgregarProducto();
          renderProductosVenta();
        });

      function renderProductosVenta() {
        const container = document.getElementById("productosVentaList");
        if (productosVenta.length === 0) {
          container.innerHTML = '<p class="no-data">üì¶ Sin productos</p>';
          calcularTotales();
          return;
        }
        container.innerHTML = productosVenta
          .map(
            (item, index) => `
      <div class="item-venta">
        <div class="item-info"><h4>${
          item.nombre
        }</h4><p>${item.precio_unitario.toLocaleString("es-CO")}</p></div>
        <div class="item-cantidad">
          <button type="button" onclick="cambiarCantidad(${index}, -1)">-</button>
          <input type="number" value="${
            item.cantidad
          }" onchange="actualizarCantidad(${index}, this.value)" min="1" max="${
              item.stock_disponible
            }">
          <button type="button" onclick="cambiarCantidad(${index}, 1)">+</button>
        </div>
        <div><strong>${(item.precio_unitario * item.cantidad).toLocaleString(
          "es-CO"
        )}</strong></div>
        <button class="btn-icon" onclick="eliminarProductoVenta(${index})">üóëÔ∏è</button>
      </div>
    `
          )
          .join("");
        calcularTotales();
      }

      function cambiarCantidad(index, delta) {
        const item = productosVenta[index];
        const nuevaCantidad = item.cantidad + delta;
        if (nuevaCantidad < 1 || nuevaCantidad > item.stock_disponible) return;
        item.cantidad = nuevaCantidad;
        renderProductosVenta();
      }

      function actualizarCantidad(index, valor) {
        const cantidad = parseInt(valor);
        const item = productosVenta[index];
        if (cantidad < 1 || cantidad > item.stock_disponible) {
          showAlert(
            "loginAlert",
            `‚ùå Cantidad debe estar entre 1 y ${item.stock_disponible}`,
            "error"
          );
          renderProductosVenta();
          return;
        }
        item.cantidad = cantidad;
        renderProductosVenta();
      }

      function eliminarProductoVenta(index) {
        productosVenta.splice(index, 1);
        renderProductosVenta();
      }

      function calcularTotales() {
        const subtotal = productosVenta.reduce(
          (sum, item) => sum + item.precio_unitario * item.cantidad,
          0
        );
        const descuento = 0;
        const total = subtotal - descuento;
        document.getElementById(
          "subtotalVenta"
        ).textContent = `${subtotal.toLocaleString("es-CO")}`;
        document.getElementById(
          "descuentoVenta"
        ).textContent = `${descuento.toLocaleString("es-CO")}`;
        document.getElementById(
          "totalVenta"
        ).textContent = `${total.toLocaleString("es-CO")}`;
      }

      async function procesarVenta() {
        if (productosVenta.length === 0) {
          showAlert(
            "loginAlert",
            "‚ùå Debe agregar al menos un producto",
            "error"
          );
          return;
        }
        const data = {
          id_cliente: document.getElementById("selectCliente").value || null,
          productos: productosVenta,
          metodo_pago: document.getElementById("metodoPago").value,
          observaciones: document.getElementById("observaciones").value,
          impuesto: 0,
          descuento: 0,
        };
        try {
          const response = await fetch(`${API_URL}/facturas`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            credentials: "include",
            body: JSON.stringify(data),
          });
          if (response.ok) {
            const result = await response.json();
            showAlert(
              "loginAlert",
              `‚úÖ Venta exitosa! Factura: ${
                result.numero_factura
              } - Total: $${result.total.toLocaleString("es-CO")}`,
              "exito"
            );
            productosVenta = [];
            renderProductosVenta();
            document.getElementById("selectCliente").value = "";
            document.getElementById("metodoPago").value = "efectivo";
            document.getElementById("observaciones").value = "";
            loadDashboardData();
          } else {
            const error = await response.json();
            showAlert("loginAlert", "‚ùå " + (error.error || "Error"), "error");
          }
        } catch (error) {
          showAlert("loginAlert", "‚ùå Error al procesar la venta", "error");
        }
      }

      // ====================================
      // HISTORIAL DE FACTURAS
      // ====================================

      async function loadFacturas() {
        try {
          const response = await fetch(`${API_URL}/facturas`, {
            credentials: "include",
          });
          if (response.ok) {
            const facturas = await response.json();
            renderFacturas(facturas);
          }
        } catch (error) {
          console.error("Error:", error);
        }
      }

      async function buscarFacturas() {
        const fechaInicio = document.getElementById("fechaInicio").value;
        const fechaFin = document.getElementById("fechaFin").value;
        let url = `${API_URL}/facturas?`;
        if (fechaInicio) url += `fecha_inicio=${fechaInicio}&`;
        if (fechaFin) url += `fecha_fin=${fechaFin}`;
        try {
          const response = await fetch(url, { credentials: "include" });
          if (response.ok) {
            const facturas = await response.json();
            renderFacturas(facturas);
          }
        } catch (error) {
          console.error("Error:", error);
        }
      }

      function renderFacturas(facturas) {
        const tbody = document.getElementById("facturasTable");
        if (facturas.length === 0) {
          tbody.innerHTML =
            '<tr><td colspan="7" style="text-align: center; padding: 40px;">Sin facturas</td></tr>';
          return;
        }
        const horarioBadges = {
          ma√±ana: "badge-warning",
          tarde: "badge-info",
          noche: "badge-info",
        };
        const horarioIconos = { ma√±ana: "üåÖ", tarde: "‚òÄÔ∏è", noche: "üåô" };
        tbody.innerHTML = facturas
          .map(
            (f) => `
      <tr>
        <td><strong>${f.numero_factura}</strong></td>
        <td>${new Date(f.fecha).toLocaleDateString("es-CO", {
          year: "numeric",
          month: "short",
          day: "numeric",
          hour: "2-digit",
          minute: "2-digit",
        })}</td>
        <td><span class="badge ${horarioBadges[f.horario]}">${
              horarioIconos[f.horario]
            } ${
              f.horario.charAt(0).toUpperCase() + f.horario.slice(1)
            }</span></td>
        <td>${f.nombre_cliente || "General"}</td>
        <td><strong>${parseFloat(f.total).toLocaleString("es-CO")}</strong></td>
        <td>${
          f.metodo_pago.charAt(0).toUpperCase() + f.metodo_pago.slice(1)
        }</td>
        <td><button class="btn-icon" onclick="verDetalleFactura(${
          f.id
        })">üëÅÔ∏è</button></td>
      </tr>
    `
          )
          .join("");
      }

      async function verDetalleFactura(id) {
        try {
          const response = await fetch(`${API_URL}/facturas/${id}`, {
            credentials: "include",
          });
          if (response.ok) {
            const factura = await response.json();
            mostrarDetalleFactura(factura);
          }
        } catch (error) {
          console.error("Error:", error);
        }
      }

      function mostrarDetalleFactura(f) {
        const content = `<div style="padding: 20px;"><div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 10px; color: white; margin-bottom: 20px;"><h4>Factura: ${
          f.numero_factura
        }</h4><p>üìÖ ${new Date(f.fecha).toLocaleString(
          "es-CO"
        )}</p><p>‚è∞ ${f.horario.toUpperCase()}</p></div><div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;"><p><strong>üë§ Cliente:</strong> ${
          f.nombre_cliente || "General"
        }</p>${
          f.numero_documento
            ? `<p><strong>üìÑ Doc:</strong> ${f.numero_documento}</p>`
            : ""
        }<p><strong>üí≥ Pago:</strong> ${
          f.metodo_pago
        }</p><p><strong>üë®‚Äçüíº Vendedor:</strong> ${
          f.nombre_usuario
        }</p></div><h4>üõí Productos:</h4><table style="width:100%; margin: 20px 0;"><thead><tr><th>Producto</th><th>Cant.</th><th>Precio</th><th>Subtotal</th></tr></thead><tbody>${f.detalle
          .map(
            (d) =>
              `<tr><td><strong>${d.nombre_producto}</strong><br><small>${
                d.codigo
              }</small></td><td>${d.cantidad}</td><td>${parseFloat(
                d.precio_unitario
              ).toLocaleString("es-CO")}</td><td><strong>${parseFloat(
                d.subtotal
              ).toLocaleString("es-CO")}</strong></td></tr>`
          )
          .join(
            ""
          )}</tbody></table><div style="padding: 20px; background: linear-gradient(135deg, #28a745 0%, #20c997 100%); border-radius: 10px; color: white;"><div style="display: flex; justify-content: space-between; font-size: 24px; font-weight: bold;"><span>TOTAL:</span><span>${parseFloat(
          f.total
        ).toLocaleString("es-CO")}</span></div></div>${
          f.observaciones
            ? `<div style="margin-top: 15px; padding: 15px; background: #fff3cd; border-radius: 8px;"><strong>üìù Obs:</strong> ${f.observaciones}</div>`
            : ""
        }</div>`;
        document.getElementById("detalleFacturaContent").innerHTML = content;
        document.getElementById("modalDetalleFactura").style.display = "flex";
      }

      // ‚ú® AGREGA ESTA FUNCI√ìN
      function closeModalDetalle() {
        const modal = document.getElementById("modalDetalleFactura");
        const detalle = document.getElementById("detalleFacturaContent");

        if (modal) modal.style.display = "none";
        if (detalle) detalle.innerHTML = ""; // Limpiar contenido
      }

      // ====================================
      // REPORTES - VERSI√ìN CORREGIDA
      // ====================================

      async function cargarReportes() {
        const fechaInicio = document.getElementById("reporteFechaInicio").value;
        const fechaFin = document.getElementById("reporteFechaFin").value;
        const horario = document.getElementById("horarioFiltro").value;

        if (fechaInicio && fechaFin && fechaInicio > fechaFin) {
          showAlert(
            "loginAlert",
            "‚ùå La fecha de inicio debe ser menor que la fecha final",
            "error"
          );
          return;
        }

        await Promise.all([
          cargarVentasHorario(fechaInicio, fechaFin, horario), // ‚ú® Agregamos horario aqu√≠
          cargarResumenGeneral(fechaInicio, fechaFin),
          cargarProductosVendidos(fechaInicio, fechaFin, horario),
          cargarVentasDiarias(fechaInicio, fechaFin),
        ]);
      }

      async function cargarVentasHorario(fechaInicio, fechaFin, horario = "") {
        const loading = document.getElementById("loadingHorarios");
        const content = document.getElementById("ventasHorarios");
        const noData = document.getElementById("noDataHorarios");

        loading.classList.remove("hidden");
        content.classList.add("hidden");
        noData.classList.add("hidden");

        try {
          let url = `${API_URL}/reportes/ventas-horario?`;
          if (fechaInicio) url += `fecha_inicio=${fechaInicio}&`;
          if (fechaFin) url += `fecha_fin=${fechaFin}`;

          const response = await fetch(url, { credentials: "include" });
          const data = await response.json();

          loading.classList.add("hidden");

          if (data.length === 0) {
            noData.classList.remove("hidden");
            return;
          }

          content.classList.remove("hidden");

          // ‚ú® Filtrar por horario si est√° seleccionado
          const datosFiltrados = horario
            ? data.filter((h) => h.horario === horario)
            : data;

          if (datosFiltrados.length === 0) {
            noData.classList.remove("hidden");
            content.classList.add("hidden");
            return;
          }

          renderVentasHorario(datosFiltrados);
        } catch (error) {
          loading.classList.add("hidden");
          noData.classList.remove("hidden");
          console.error("Error:", error);
        }
      }

      function renderVentasHorario(data) {
        const statsContainer = document.querySelector(
          "#ventasHorarios .stats-horarios"
        );
        const chartContainer = document.querySelector(
          "#ventasHorarios .bar-chart"
        );
        const iconos = { ma√±ana: "üåÖ", tarde: "‚òÄÔ∏è", noche: "üåô" };

        statsContainer.innerHTML = data
          .map(
            (h) => `
      <div class="stat-horario ${h.horario}">
        <div class="stat-horario-icono">${iconos[h.horario]}</div>
        <h4>${h.horario.toUpperCase()}</h4>
        <div class="valor">${h.monto_total.toLocaleString("es-CO")}</div>
        <div class="detalle">
          ${h.cantidad_ventas} ventas<br>
          Prom: ${h.promedio_venta.toLocaleString("es-CO", {
            maximumFractionDigits: 0,
          })}
        </div>
      </div>
    `
          )
          .join("");

        const maxMonto = Math.max(...data.map((h) => h.monto_total));

        chartContainer.innerHTML = data
          .map((h) => {
            const altura = (h.monto_total / maxMonto) * 100;
            return `
        <div class="bar-item">
          <div class="bar" style="height: ${altura}%;">
            <div class="bar-value">${(h.monto_total / 1000).toFixed(0)}k</div>
          </div>
          <div class="bar-label">
            ${iconos[h.horario]} ${h.horario.toUpperCase()}<br>
            <small>${h.cantidad_ventas} ventas</small>
          </div>
        </div>
      `;
          })
          .join("");
      }

      async function cargarResumenGeneral(fechaInicio, fechaFin) {
        const loading = document.getElementById("loadingResumen");
        const content = document.getElementById("resumenGeneral");

        loading.classList.remove("hidden");
        content.classList.add("hidden");

        try {
          let url = `${API_URL}/reportes/resumen-general?`;
          if (fechaInicio) url += `fecha_inicio=${fechaInicio}&`;
          if (fechaFin) url += `fecha_fin=${fechaFin}`;

          const response = await fetch(url, { credentials: "include" });
          const data = await response.json();

          loading.classList.add("hidden");
          content.classList.remove("hidden");

          renderResumenGeneral(data);
        } catch (error) {
          loading.classList.add("hidden");
          console.error("Error:", error);
        }
      }

      function renderResumenGeneral(data) {
        const container = document.querySelector(
          "#resumenGeneral .resumen-general"
        );

        container.innerHTML = `
    <div class="resumen-item">
      <h5>üí∞ Total Ventas</h5>
      <div class="valor">${
        data.monto_total?.toLocaleString("es-CO") || "0"
      }</div>
    </div>
    <div class="resumen-item">
      <h5>üßæ Facturas</h5>
      <div class="valor">${data.total_facturas || 0}</div>
    </div>
    <div class="resumen-item">
      <h5>üìä Promedio</h5>
      <div class="valor">${
        data.promedio_factura?.toLocaleString("es-CO", {
          maximumFractionDigits: 0,
        }) || "0"
      }</div>
    </div>
    <div class="resumen-item">
      <h5>üíµ Efectivo</h5>
      <div class="valor">${data.efectivo?.toLocaleString("es-CO") || "0"}</div>
    </div>
    <div class="resumen-item">
      <h5>üí≥ Tarjeta</h5>
      <div class="valor">${data.tarjeta?.toLocaleString("es-CO") || "0"}</div>
    </div>
    <div class="resumen-item">
      <h5>üè¶ Transferencia</h5>
      <div class="valor">${
        data.transferencia?.toLocaleString("es-CO") || "0"
      }</div>
    </div>
  `;
      }

      async function cargarProductosVendidos(fechaInicio, fechaFin, horario) {
        const loading = document.getElementById("loadingProductos");
        const content = document.getElementById("productosVendidos");
        const noData = document.getElementById("noDataProductos");

        loading.classList.remove("hidden");
        content.classList.add("hidden");
        noData.classList.add("hidden");

        try {
          let url = `${API_URL}/reportes/productos-vendidos?`;
          if (fechaInicio) url += `fecha_inicio=${fechaInicio}&`;
          if (fechaFin) url += `fecha_fin=${fechaFin}&`;
          if (horario) url += `horario=${horario}`;

          const response = await fetch(url, { credentials: "include" });
          const data = await response.json();

          loading.classList.add("hidden");

          if (data.length === 0) {
            noData.classList.remove("hidden");
            return;
          }

          content.classList.remove("hidden");
          renderProductosVendidos(data);
        } catch (error) {
          loading.classList.add("hidden");
          noData.classList.remove("hidden");
          console.error("Error:", error);
        }
      }

      function renderProductosVendidos(data) {
        const tbody = document.getElementById("productosVendidosTable");

        tbody.innerHTML = data
          .map((p, index) => {
            const medalla =
              index === 0
                ? "ü•á"
                : index === 1
                ? "ü•à"
                : index === 2
                ? "ü•â"
                : `${index + 1}¬∞`;

            return `
        <tr>
          <td style="font-size: 24px; text-align: center;">${medalla}</td>
          <td>
            <strong>${p.nombre}</strong><br>
            <small style="color: #666;">${p.codigo}</small>
          </td>
          <td>${p.categoria || "-"}</td>
          <td><strong>${p.cantidad_vendida}</strong> u</td>
          <td><strong>${p.total_vendido.toLocaleString("es-CO")}</strong></td>
          <td>${p.numero_facturas} facturas</td>
        </tr>
      `;
          })
          .join("");
      }

      async function cargarVentasDiarias(fechaInicio, fechaFin) {
        const loading = document.getElementById("loadingDiarias");
        const content = document.getElementById("ventasDiarias");
        const noData = document.getElementById("noDataDiarias");

        loading.classList.remove("hidden");
        content.classList.add("hidden");
        noData.classList.add("hidden");

        try {
          let url = `${API_URL}/reportes/ventas-diarias?`;
          if (fechaInicio) url += `fecha_inicio=${fechaInicio}&`;
          if (fechaFin) url += `fecha_fin=${fechaFin}`;

          const response = await fetch(url, { credentials: "include" });
          const data = await response.json();

          loading.classList.add("hidden");

          if (data.length === 0) {
            noData.classList.remove("hidden");
            return;
          }

          content.classList.remove("hidden");
          renderVentasDiarias(data);
        } catch (error) {
          loading.classList.add("hidden");
          noData.classList.remove("hidden");
          console.error("Error:", error);
        }
      }

      function renderVentasDiarias(data) {
        const chartContainer = document.querySelector(
          "#ventasDiarias .bar-chart"
        );
        const dataLimitada = data.slice(-15);
        const maxMonto = Math.max(...dataLimitada.map((d) => d.monto_total));

        chartContainer.innerHTML = dataLimitada
          .map((d) => {
            const altura = (d.monto_total / maxMonto) * 100;
            const fecha = new Date(d.fecha + "T00:00:00");
            const fechaFormato = fecha.toLocaleDateString("es-CO", {
              day: "2-digit",
              month: "short",
            });

            return `
        <div class="bar-item">
          <div class="bar" style="height: ${altura}%;">
            <div class="bar-value">${(d.monto_total / 1000).toFixed(0)}k</div>
          </div>
          <div class="bar-label">
            ${fechaFormato}<br>
            <small>${d.cantidad_ventas} ventas</small>
          </div>
        </div>
      `;
          })
          .join("");
      }
      // ====================================
      // FUNCIONES EXTRA PARA FACTURAS
      // ====================================

      function showModalDetalleFactura(htmlFactura) {
        const modal = document.getElementById("modalDetalleFactura");
        const detalle = document.getElementById("detalleFacturaContent");
        detalle.innerHTML = htmlFactura || "";
        modal.style.display = "flex";
      }

      function imprimirFactura() {
        const contenido = document.getElementById(
          "detalleFacturaContent"
        ).innerHTML;
        const tituloFactura =
          (contenido.match(/Factura:\s*(\w+)/) || [])[1] || "Factura";
        const ventana = window.open("", tituloFactura, "width=900,height=700");
        ventana.document.write(`
    <html>
    <head>
      <title>${tituloFactura}</title>
      <style>
        body { font-family: Arial, sans-serif; padding: 30px; }
        h2, h3 { color: #333; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
        th { background: #f2f2f2; }
        .total { font-weight: bold; font-size: 20px; text-align: right; margin-top: 20px; }
      </style>
    </head>
    <body>
      ${contenido}
    </body>
    </html>
  `);
        ventana.document.close();
        ventana.focus();
        ventana.print();
      }

      function guardarFacturaPDF() {
        if (typeof html2pdf === "undefined") {
          showAlert(
            "loginAlert",
            "‚ö†Ô∏è Error: Librer√≠a PDF no disponible",
            "error"
          );
          return;
        }
        const elemento = document.getElementById("detalleFacturaContent");
        if (!elemento) {
          showAlert(
            "loginAlert",
            "‚ùå No se encontr√≥ el contenido de la factura",
            "error"
          );
          return;
        }
        const nombreFactura =
          (elemento.innerHTML.match(/Factura:\s*(\w+)/) || [])[1] || "Factura";
        const opciones = {
          margin: 10,
          filename: `${nombreFactura}.pdf`,
          image: { type: "jpeg", quality: 0.98 },
          html2canvas: { scale: 2 },
          jsPDF: { unit: "mm", format: "a4", orientation: "portrait" },
        };
        html2pdf().set(opciones).from(elemento).save();
      }

      // ====================================
      // INICIALIZACI√ìN
      // ====================================

      window.addEventListener("load", async () => {
        try {
          const response = await fetch(`${API_URL}/session`, {
            credentials: "include",
          });
          if (response.ok) {
            const data = await response.json();
            if (data.authenticated) {
              currentUser = data.user;
              showDashboard();
            }
          }
        } catch (error) {
          document.getElementById("loginPage").style.display = "flex";
        }
      });

      window.onclick = function (event) {
        if (event.target.classList.contains("modal")) {
          event.target.style.display = "none";
        }
      };
      // ====================================
      // FUNCIONES PARA ACTUALIZAR GR√ÅFICOS DIN√ÅMICAMENTE
      // ====================================

      // Actualizar mini gr√°fico de barras (√∫ltimos 7 d√≠as de productos agregados)
      function actualizarGraficoProductos(data) {
        const card = document
          .getElementById("totalProductos")
          .closest(".stat-card");
        const barras = card.querySelectorAll(".stat-chart-bar");

        if (barras.length > 0) {
          // Generar valores aleatorios basados en el total (simula √∫ltimos 7 d√≠as)
          const total = parseInt(data.total_productos) || 0;
          const valores = [];
          for (let i = 0; i < 7; i++) {
            valores.push(Math.random() * 100);
          }

          // Normalizar valores para que el m√°s alto sea 90%
          const max = Math.max(...valores);
          valores.forEach((valor, index) => {
            if (barras[index]) {
              const altura = (valor / max) * 90;
              barras[index].style.height = altura + "%";
            }
          });
        }
      }

      // Actualizar c√≠rculo de progreso (productos bajo stock)
      function actualizarCirculoStock(data) {
        const circulo = document.querySelector(".progress-ring-circle");
        if (!circulo) return;

        const total = parseInt(data.total_productos) || 1;
        const bajoStock = parseInt(data.productos_bajo_stock) || 0;

        // Calcular porcentaje de productos con stock bajo
        const porcentaje = (bajoStock / total) * 100;

        // Calcular offset del c√≠rculo (125.6 = 2 √ó œÄ √ó 20)
        const circunferencia = 125.6;
        const offset = circunferencia - (porcentaje / 100) * circunferencia;

        circulo.style.strokeDashoffset = offset;

        // Cambiar color seg√∫n el nivel
        if (porcentaje > 50) {
          circulo.setAttribute("stroke", "#dc3545"); // Rojo
        } else if (porcentaje > 25) {
          circulo.setAttribute("stroke", "#ffc107"); // Amarillo
        } else {
          circulo.setAttribute("stroke", "#28a745"); // Verde
        }
      }

      // Actualizar gr√°fico de barras de ventas (√∫ltimos 6 d√≠as)
      function actualizarGraficoVentas(data) {
        const card = document.getElementById("ventasHoy").closest(".stat-card");
        const barras = card.querySelectorAll(".stat-chart-bar");

        if (barras.length > 0) {
          const ventasHoy = parseInt(data.ventas_hoy) || 0;

          // Simular historial de √∫ltimos 6 d√≠as (creciente hacia hoy)
          const valores = [];
          for (let i = 0; i < 6; i++) {
            valores.push(30 + i * 10 + Math.random() * 20);
          }

          const max = Math.max(...valores);
          valores.forEach((valor, index) => {
            if (barras[index]) {
              const altura = (valor / max) * 95;
              barras[index].style.height = altura + "%";
            }
          });
        }
      }

      // Actualizar indicador de tendencia de ventas
      function actualizarTendenciaVentas(ventasHoy, ventasAyer = 0) {
        const indicador = document.querySelector(".trend-indicator");
        if (!indicador) return;

        if (ventasHoy > ventasAyer) {
          indicador.textContent = "üìà";
          indicador.style.color = "#28a745";
        } else if (ventasHoy < ventasAyer) {
          indicador.textContent = "üìâ";
          indicador.style.color = "#dc3545";
        } else {
          indicador.textContent = "‚û°Ô∏è";
          indicador.style.color = "#6c757d";
        }
      }

      // MODIFICAR LA FUNCI√ìN loadDashboardData EXISTENTE
      // Busca esta funci√≥n en tu c√≥digo y reempl√°zala por esta versi√≥n mejorada:

      async function loadDashboardData() {
        try {
          const response = await fetch(`${API_URL}/dashboard`, {
            credentials: "include",
          });
          if (response.ok) {
            const data = await response.json();

            // Actualizar valores num√©ricos (como antes)
            document.getElementById("totalProductos").textContent =
              data.total_productos;
            document.getElementById("productosBajoStock").textContent =
              data.productos_bajo_stock;
            document.getElementById("ventasHoy").textContent = data.ventas_hoy;
            document.getElementById(
              "montoVentasHoy"
            ).textContent = `${data.monto_ventas_hoy.toLocaleString("es-CO")}`;

            // Actualizar gr√°ficos din√°micamente
            actualizarGraficoProductos(data);
            actualizarCirculoStock(data);
            actualizarGraficoVentas(data);
            actualizarTendenciaVentas(data.ventas_hoy, 0); // El 0 ser√≠a ventas de ayer
          }
        } catch (error) {
          console.error("Error:", error);
        }
      }

      // ====================================
      // FUNCIONES OPCIONALES (SI QUIERES DATOS M√ÅS REALES)
      // ====================================

      // Si quieres obtener datos hist√≥ricos reales desde el backend
      async function cargarHistorialVentas() {
        try {
          // Calcular fechas (√∫ltimos 7 d√≠as)
          const hoy = new Date();
          const hace7dias = new Date();
          hace7dias.setDate(hoy.getDate() - 7);

          const fechaInicio = hace7dias.toISOString().split("T")[0];
          const fechaFin = hoy.toISOString().split("T")[0];

          const response = await fetch(
            `${API_URL}/reportes/ventas-diarias?fecha_inicio=${fechaInicio}&fecha_fin=${fechaFin}`,
            {
              credentials: "include",
            }
          );

          if (response.ok) {
            const data = await response.json();

            // Actualizar gr√°fico con datos reales
            const card = document
              .getElementById("ventasHoy")
              .closest(".stat-card");
            const barras = card.querySelectorAll(".stat-chart-bar");

            if (barras.length > 0 && data.length > 0) {
              const maxMonto = Math.max(...data.map((d) => d.monto_total));

              data.slice(-6).forEach((dia, index) => {
                if (barras[index]) {
                  const altura = (dia.monto_total / maxMonto) * 95;
                  barras[index].style.height = altura + "%";
                }
              });
            }
          }
        } catch (error) {
          console.error("Error cargando historial:", error);
        }
      }
      cargarHistorialVentas();
    </script>
  </body>
</html>
